

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="readthedocs-addons-api-version" content="1"><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Background jobs (Cron) &mdash; Nextcloud latest Developer Manual latest documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=bad88653" />
      <link rel="stylesheet" type="text/css" href="../_static/dark_mode_css/general.css?v=c0a7eb24" />
      <link rel="stylesheet" type="text/css" href="../_static/dark_mode_css/dark.css?v=70edf1c7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=f4332903"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
      <script src="../_static/dark_mode_js/default_light.js?v=c2e647ce"></script>
      <script src="../_static/dark_mode_js/theme_switcher.js?v=358d3910"></script>
    <script src="../_static/js/theme.js"></script>
    <script src="../_static/js/versions.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Caching" href="caching.html" />
    <link rel="prev" title="Translations" href="translations.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html">
            
              <img src="../_static/logo-white.png" class="logo" alt="Logo"/>
          </a>
              <div class="switch-menus">
                <div class="version-switch"></div>
                <div class="language-switch"></div>
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../prologue/index.html">Prologue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/index.html">Getting started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Basic concepts</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="request_lifecycle.html">Request lifecycle</a></li>
<li class="toctree-l2"><a class="reference internal" href="routing.html">Routing</a></li>
<li class="toctree-l2"><a class="reference internal" href="dependency_injection.html">Dependency injection</a></li>
<li class="toctree-l2"><a class="reference internal" href="controllers.html">Controllers</a></li>
<li class="toctree-l2"><a class="reference internal" href="middlewares.html">Middlewares</a></li>
<li class="toctree-l2"><a class="reference internal" href="events.html">Events</a></li>
<li class="toctree-l2"><a class="reference internal" href="front-end/index.html">Front-end</a></li>
<li class="toctree-l2"><a class="reference internal" href="translations.html">Translations</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Background jobs (Cron)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#types-of-background-jobs">Types of background jobs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#writing-a-background-job">Writing a background job</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#heavy-load-and-time-insensitive">Heavy load and time insensitive</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuring-parallelism">Configuring parallelism</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#registering-a-background-job">Registering a background job</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#info-xml">info.xml</a></li>
<li class="toctree-l4"><a class="reference internal" href="#registering-manually">Registering manually</a></li>
<li class="toctree-l4"><a class="reference internal" href="#scheduling">Scheduling</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="caching.html">Caching</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="setting.html">Settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="storage/index.html">Storage and database</a></li>
<li class="toctree-l2"><a class="reference internal" href="public_share_template.html">Public share template</a></li>
<li class="toctree-l2"><a class="reference internal" href="testing.html">Testing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../app_development/index.html">App development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exapp_development/index.html">ExApp development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server/index.html">Server development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digging_deeper/index.html">Digging deeper</a></li>
<li class="toctree-l1"><a class="reference internal" href="../app_publishing_maintenance/index.html">App publishing and maintenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/index.html">Interface &amp; interaction design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../html_css_design/index.html">HTML/CSS guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../client_apis/index.html">Clients and Client APIs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Nextcloud latest Developer Manual</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Basic concepts</a></li>
      <li class="breadcrumb-item active">Background jobs (Cron)</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/nextcloud/documentation/edit/master/developer_manual/basics/backgroundjobs.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="background-jobs-cron">
<span id="app-backgroundjobs"></span><h1>Background jobs (Cron)<a class="headerlink" href="#background-jobs-cron" title="Link to this heading"></a></h1>
<p>Often there is a need to run background jobs. For example there are Background
jobs in Nextcloud that send out the activity emails. Or expire the trashbin.</p>
<section id="types-of-background-jobs">
<h2>Types of background jobs<a class="headerlink" href="#types-of-background-jobs" title="Link to this heading"></a></h2>
<p>Nextcloud by default offers you two types of background jobs. The <code class="docutils literal notranslate"><span class="pre">\OCP\BackgroundJob\QueuedJob</span></code>
and <code class="docutils literal notranslate"><span class="pre">\OCP\BackgroundJob\TimedJob</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">QueuedJob</span></code> is for one time jobs. This can for example be triggered by inserting
a job because an event happened. The <code class="docutils literal notranslate"><span class="pre">TimedJob</span></code> has a method <code class="docutils literal notranslate"><span class="pre">setInterval</span></code> where
you can set the time minimum time in seconds between the jobs (from the constructor).
This is useful in case you want to have a job that is run at most once a day for example.</p>
<p>Of course you can customize this all to your liking by just extending <code class="docutils literal notranslate"><span class="pre">\OCP\BackgroundJob\Job</span></code></p>
</section>
<section id="writing-a-background-job">
<h2>Writing a background job<a class="headerlink" href="#writing-a-background-job" title="Link to this heading"></a></h2>
<p>Writing a background job is rather straight forward. You write a class and extend
your job class of choice.</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">namespace</span> <span class="nx">OCA\MyApp\Cron</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCA\MyApp\Service\SomeService</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\BackgroundJob\TimedJob</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\AppFramework\Utility\ITimeFactory</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">SomeTask</span> <span class="k">extends</span> <span class="nx">TimedJob</span> <span class="p">{</span>

    <span class="k">private</span> <span class="nx">SomeService</span> <span class="nv">$myService</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">ITimeFactory</span> <span class="nv">$time</span><span class="p">,</span> <span class="nx">SomeService</span> <span class="nv">$service</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$time</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">myService</span> <span class="o">=</span> <span class="nv">$service</span><span class="p">;</span>

        <span class="c1">// Run once an hour</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setInterval</span><span class="p">(</span><span class="mi">3600</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">run</span><span class="p">(</span><span class="nv">$arguments</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">myService</span><span class="o">-&gt;</span><span class="na">doCron</span><span class="p">(</span><span class="nv">$arguments</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>As you can see our dependency injection also works just fine for background jobs.
The ITimeFactory always needs to be passed to the parent constructor. Since it is
required to be set.</p>
<p>In this case it is a background job that runs every hour. And we take the <code class="docutils literal notranslate"><span class="pre">uid</span></code> argument
to pass on to the service to run the background job.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">run</span></code> function is the main thing you need to implement and where all the
logic happens.</p>
<section id="heavy-load-and-time-insensitive">
<span id="app-backgroundjobs-time-sensitivity"></span><h3>Heavy load and time insensitive<a class="headerlink" href="#heavy-load-and-time-insensitive" title="Link to this heading"></a></h3>
<p>When the background job is a <code class="docutils literal notranslate"><span class="pre">\OCP\BackgroundJob\TimedJob</span></code> and can impact the performance of
the instance and is not time sensitive, e.g. clearing old data, running training of AI models
or similar things, consider flagging it as time insensitive in the constructor.</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="c1">// Run once a day</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setInterval</span><span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">);</span>
<span class="c1">// Delay until low-load time</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setTimeSensitivity</span><span class="p">(</span><span class="nx">\OCP\BackgroundJob\IJob</span><span class="o">::</span><span class="na">TIME_INSENSITIVE</span><span class="p">);</span>
</pre></div>
</div>
<p>This allows the Nextcloud to delay the job until a given nightly time window so the users
are not that impacted by the heavy load of the background job.</p>
</section>
<section id="configuring-parallelism">
<h3>Configuring parallelism<a class="headerlink" href="#configuring-parallelism" title="Link to this heading"></a></h3>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 27.</span></p>
</div>
<p>With resource-heavy background jobs that run for longer than a few minutes, be they <code class="docutils literal notranslate"><span class="pre">QueuedJob</span></code> and <code class="docutils literal notranslate"><span class="pre">TimedJob</span></code> instances, you may want to restrict parallelism to prevent multiple such jobs from clogging up the server’s resources. You can do this with the <code class="docutils literal notranslate"><span class="pre">setAllowParallelRuns</span></code> method of <code class="docutils literal notranslate"><span class="pre">OCP\BackgroundJob\Job</span></code> (<code class="docutils literal notranslate"><span class="pre">QueuedJob</span></code> and <code class="docutils literal notranslate"><span class="pre">TimedJob</span></code> both inherit from this class, so they also have this available).</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="c1">// Only run one instance of this job at a time</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setAllowParallelRuns</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
</pre></div>
</div>
</section>
</section>
<section id="registering-a-background-job">
<h2>Registering a background job<a class="headerlink" href="#registering-a-background-job" title="Link to this heading"></a></h2>
<p>Now that you have written your background job there is of course the small matter of
how to make sure the system actually runs your job. In order to do this your
job needs to be registered.</p>
<section id="info-xml">
<h3>info.xml<a class="headerlink" href="#info-xml" title="Link to this heading"></a></h3>
<p>You can register your jobs in your info.xml by adding;</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;background-jobs&gt;</span>
<span class="w">    </span><span class="nt">&lt;job&gt;</span>OCA\MyApp\Cron\SomeTask<span class="nt">&lt;/job&gt;</span>
<span class="nt">&lt;/background-jobs&gt;</span>
</pre></div>
</div>
<p>This will on install/update of the application add the job <code class="docutils literal notranslate"><span class="pre">OCA\MyApp\Cron\SomeTask</span></code>.
Of course in this case the arguments passed to your <code class="docutils literal notranslate"><span class="pre">run</span></code> function is just an empty
array.</p>
</section>
<section id="registering-manually">
<h3>Registering manually<a class="headerlink" href="#registering-manually" title="Link to this heading"></a></h3>
<p>In case you want more fine grained control about when a background job is inserted
and you want to pass arguments to it you need to manually register your background jobs.</p>
<p>You do this by using <code class="docutils literal notranslate"><span class="pre">\OCP\BackgroundJob\IJobList</span></code>. There you can add a job or remove a job.</p>
<p>For example you could add or remove a certain job based on some controller:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">namespace</span> <span class="nx">OCA\MyApp\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCA\MyApp\Cron\SomeTask</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\AppFramework\Controller</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\BackgroundJob\IJobList</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\IRequest</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">SomeController</span> <span class="k">extends</span> <span class="nx">Controller</span> <span class="p">{</span>

    <span class="k">private</span> <span class="nx">IJobList</span> <span class="nv">$jobList</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$appName</span><span class="p">,</span> <span class="nx">IRequest</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">IJobList</span> <span class="nv">$jobList</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$appName</span><span class="p">,</span> <span class="nv">$request</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">jobList</span> <span class="o">=</span> <span class="nv">$jobList</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">addJob</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$uid</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">jobList</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nx">SomeTask</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;uid&#39;</span> <span class="o">=&gt;</span> <span class="nv">$uid</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">removeJob</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$uid</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">jobList</span><span class="o">-&gt;</span><span class="na">remove</span><span class="p">(</span><span class="nx">SomeTask</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;uid&#39;</span> <span class="o">=&gt;</span> <span class="nv">$uid</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This provides more fine grained control and you can pass arguments to your background
jobs easily.</p>
</section>
<section id="scheduling">
<h3>Scheduling<a class="headerlink" href="#scheduling" title="Link to this heading"></a></h3>
<p>A background job can be scheduled to run after a specific time and date. This avoids maintaining a time check inside a background job.</p>
<p>Beware that the reliability of the execution time is limited. Systems that do not use system cron may have no active users and therefore no reliable cron trigger at the target time. System cron can also not guarantee that the job is picked up right away if the background job queue is full. The only guarantee you get is that the job is not picked up earlier than the specified time.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">lib/Service/ShareService.php</span><a class="headerlink" href="#id1" title="Link to this code"></a></div>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">OCA\MyApp\Service</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCA\MyApp\BackgroundJob\RevokeShare</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\BackgroundJob\IJobList</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ShareService</span> <span class="p">{</span>

    <span class="k">private</span> <span class="nx">IJobList</span> <span class="nv">$jobList</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">IJobList</span> <span class="nv">$jobList</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">jobList</span> <span class="o">=</span> <span class="nv">$jobList</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">shareWithUser</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$uid</span><span class="p">,</span> <span class="nx">int</span> <span class="nv">$expiration</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// create an expiring share</span>

<span class="hll">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">jobList</span><span class="o">-&gt;</span><span class="na">scheduleAfter</span><span class="p">(</span>
</span><span class="hll">            <span class="nx">RevokeShare</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
</span><span class="hll">            <span class="p">[</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$shareId</span><span class="p">],</span>
</span><span class="hll">            <span class="nv">$expiration</span><span class="p">,</span>
</span><span class="hll">        <span class="p">);</span>
</span>    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="translations.html" class="btn btn-neutral float-left" title="Translations" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="caching.html" class="btn btn-neutral float-right" title="Caching" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025 Nextcloud GmbH.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="https://docs.nextcloud.com/server/28/developer_manual">28</a></dd>
        
          <dd><a href="https://docs.nextcloud.com/server/29/developer_manual">29</a></dd>
        
          <dd><a href="https://docs.nextcloud.com/server/30/developer_manual">30</a></dd>
        
          <dd><a href="https://docs.nextcloud.com/server/stable/developer_manual">stable</a></dd>
        
          <dd><a href="https://docs.nextcloud.com/server/latest/developer_manual">latest</a></dd>
        
      </dl>
    </div>
  </div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>