

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="readthedocs-addons-api-version" content="1"><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Middlewares &mdash; Nextcloud latest Developer Manual latest documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=8ff6e0db" />
      <link rel="stylesheet" type="text/css" href="../_static/dark_mode_css/general.css?v=c0a7eb24" />
      <link rel="stylesheet" type="text/css" href="../_static/dark_mode_css/dark.css?v=70edf1c7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=f4332903"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
      <script src="../_static/dark_mode_js/default_light.js?v=c2e647ce"></script>
      <script src="../_static/dark_mode_js/theme_switcher.js?v=358d3910"></script>
    <script src="../_static/js/theme.js"></script>
    <script src="../_static/js/versions.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Events" href="events.html" />
    <link rel="prev" title="Controllers" href="controllers.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html">
            
              <img src="../_static/logo-white.png" class="logo" alt="Logo"/>
          </a>
              <div class="switch-menus">
                <div class="version-switch"></div>
                <div class="language-switch"></div>
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../prologue/index.html">Prologue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/index.html">Getting started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Basic concepts</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="request_lifecycle.html">Request lifecycle</a></li>
<li class="toctree-l2"><a class="reference internal" href="routing.html">Routing</a></li>
<li class="toctree-l2"><a class="reference internal" href="dependency_injection.html">Dependency injection</a></li>
<li class="toctree-l2"><a class="reference internal" href="controllers.html">Controllers</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Middlewares</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#global-middlewares">Global Middlewares</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dependency-injection-container-registration">Dependency Injection Container Registration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#parsing-annotations">Parsing annotations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="events.html">Events</a></li>
<li class="toctree-l2"><a class="reference internal" href="front-end/index.html">Front-end</a></li>
<li class="toctree-l2"><a class="reference internal" href="translations.html">Translations</a></li>
<li class="toctree-l2"><a class="reference internal" href="backgroundjobs.html">Background jobs (Cron)</a></li>
<li class="toctree-l2"><a class="reference internal" href="caching.html">Caching</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="setting.html">Settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="storage/index.html">Storage and database</a></li>
<li class="toctree-l2"><a class="reference internal" href="public_share_template.html">Public share template</a></li>
<li class="toctree-l2"><a class="reference internal" href="testing.html">Testing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../app_development/index.html">App development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exapp_development/index.html">ExApp development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server/index.html">Server development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digging_deeper/index.html">Digging deeper</a></li>
<li class="toctree-l1"><a class="reference internal" href="../app_publishing_maintenance/index.html">App publishing and maintenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/index.html">Interface &amp; interaction design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../html_css_design/index.html">HTML/CSS guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../client_apis/index.html">Clients and Client APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../desktop/index.html">Desktop Clients</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Nextcloud latest Developer Manual</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Basic concepts</a></li>
      <li class="breadcrumb-item active">Middlewares</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/nextcloud/documentation/edit/master/developer_manual/basics/middlewares.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="middlewares">
<h1>Middlewares<a class="headerlink" href="#middlewares" title="Link to this heading"></a></h1>
<p>Middleware is logic that is run before and after each request and is modeled after <a class="reference external" href="https://docs.djangoproject.com/en/dev/topics/http/middleware/">Django’s Middleware system</a>. It offers the following hooks:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">beforeController</span></code>: This is executed before a controller method is being executed. This allows you to plug additional checks or logic before that method, like for instance security checks</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">afterException</span></code>: This is being run when either the beforeController method or the controller method itself is throwing an exception. The middleware is asked in reverse order to handle the exception and to return a response. If the middleware can’t handle the exception, it throws the exception again</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">afterController</span></code>: This is being run after a successful controller method call and allows the manipulation of a Response object. The middleware is run in reverse order</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">beforeOutput</span></code>: This is being run after the response object has been rendered and allows the manipulation of the outputted text. The middleware is run in reverse order</p></li>
</ul>
<figure class="align-default">
<img alt="Middleware flow chart" src="../_images/middleware-flow-horiz.png" />
</figure>
<p>To generate your own middleware, simply inherit from the Middleware class and overwrite the methods that should be used.</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">OCA\MyApp\Middleware</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">\OCP\AppFramework\Middleware</span><span class="p">;</span>


<span class="k">class</span> <span class="nc">CensorMiddleware</span> <span class="k">extends</span> <span class="nx">Middleware</span> <span class="p">{</span>

    <span class="sd">/**</span>
<span class="sd">     * this replaces &quot;bad words&quot; with &quot;********&quot; in the output</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeOutput</span><span class="p">(</span><span class="nv">$controller</span><span class="p">,</span> <span class="nv">$methodName</span><span class="p">,</span> <span class="nv">$output</span><span class="p">)</span><span class="o">:</span> <span class="nx">string</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">&#39;bad words&#39;</span><span class="p">,</span> <span class="s1">&#39;********&#39;</span><span class="p">,</span> <span class="nv">$output</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>The middleware can be registered in the app’s <code class="docutils literal notranslate"><span class="pre">Application</span></code> class:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">lib/AppInfo/Application.php</span><a class="headerlink" href="#id2" title="Link to this code"></a></div>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">declare</span><span class="p">(</span><span class="nx">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="k">namespace</span> <span class="nx">OCA\MyApp\AppInfo</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCA\MyApp\Middleware\CensorMiddleware</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\AppFramework\App</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\AppFramework\Bootstrap\IBootContext</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\AppFramework\Bootstrap\IBootstrap</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\AppFramework\Bootstrap\IRegistrationContext</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Application</span> <span class="k">extends</span> <span class="nx">App</span> <span class="k">implements</span> <span class="nx">IBootstrap</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="s1">&#39;myapp&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">register</span><span class="p">(</span><span class="nx">IRegistrationContext</span> <span class="nv">$context</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span> <span class="p">{</span>
<span class="hll">        <span class="nv">$context</span><span class="o">-&gt;</span><span class="na">registerMiddleware</span><span class="p">(</span><span class="nx">CensorMiddleware</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
</span>    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">boot</span><span class="p">(</span><span class="nx">IBootContext</span> <span class="nv">$context</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span> <span class="p">{}</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
<section id="global-middlewares">
<span id="id1"></span><h2>Global Middlewares<a class="headerlink" href="#global-middlewares" title="Link to this heading"></a></h2>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 26.</span></p>
</div>
<p>Registered middleware will only intercept requests of the same app by default. To make a middleware <em>global</em> and trigger for other apps’ middleware, add <cite>true</cite> as the second argument of the <code class="docutils literal notranslate"><span class="pre">registerMiddleware</span></code> call:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">lib/AppInfo/Application.php</span><a class="headerlink" href="#id3" title="Link to this code"></a></div>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">declare</span><span class="p">(</span><span class="nx">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="k">namespace</span> <span class="nx">OCA\MyApp\AppInfo</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCA\MyApp\Middleware\MonitoringMiddleware</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\AppFramework\App</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\AppFramework\Bootstrap\IBootContext</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\AppFramework\Bootstrap\IBootstrap</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\AppFramework\Bootstrap\IRegistrationContext</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Application</span> <span class="k">extends</span> <span class="nx">App</span> <span class="k">implements</span> <span class="nx">IBootstrap</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="s1">&#39;myapp&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">register</span><span class="p">(</span><span class="nx">IRegistrationContext</span> <span class="nv">$context</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span> <span class="p">{</span>
<span class="hll">        <span class="nv">$context</span><span class="o">-&gt;</span><span class="na">registerMiddleware</span><span class="p">(</span><span class="nx">MonitoringMiddleware</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span>    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">boot</span><span class="p">(</span><span class="nx">IBootContext</span> <span class="nv">$context</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span> <span class="p">{}</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="dependency-injection-container-registration">
<h2>Dependency Injection Container Registration<a class="headerlink" href="#dependency-injection-container-registration" title="Link to this heading"></a></h2>
<div class="deprecated">
<p><span class="versionmodified deprecated">Deprecated since version 20.</span></p>
</div>
<p>Middleware can also be added using the <strong>registerMiddleware</strong> method of the container:</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">lib/AppInfo/Application.php</span><a class="headerlink" href="#id4" title="Link to this code"></a></div>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">OCA\MyApp\AppInfo</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCP\AppFramework\App</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\IServerContainer</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCA\MyApp\Middleware\CensorMiddleware</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyApp</span> <span class="k">extends</span> <span class="nx">App</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="k">array</span> <span class="nv">$urlParams</span> <span class="o">=</span> <span class="p">[])</span> <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="s1">&#39;myapp&#39;</span><span class="p">,</span> <span class="nv">$urlParams</span><span class="p">);</span>

<span class="hll">        <span class="nv">$container</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getContainer</span><span class="p">();</span>
</span><span class="hll">
</span><span class="hll">        <span class="c1">// executed in the order that it is registered</span>
</span><span class="hll">        <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">registerMiddleware</span><span class="p">(</span><span class="nx">CensorMiddleware</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
</span>    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The order is important! The middleware that is registered first gets run first in the <strong>beforeController</strong> method. For all other hooks, the order is being reversed, meaning: if a middleware is registered first, it gets run last.</p>
</div>
</section>
<section id="parsing-annotations">
<h2>Parsing annotations<a class="headerlink" href="#parsing-annotations" title="Link to this heading"></a></h2>
<p>Sometimes it is useful to conditionally execute code before or after a controller method. This can be done by defining custom annotations. An example would be to add a custom authentication method or simply add an additional header to the response. To access the parsed annotations, inject the <strong>ControllerMethodReflector</strong> class:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">OCA\MyApp\Middleware</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCP\AppFramework\Middleware</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\AppFramework\Utility\IControllerMethodReflector</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\AppFramework\Http\Response</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">HeaderMiddleware</span> <span class="k">extends</span> <span class="nx">Middleware</span> <span class="p">{</span>

  <span class="k">private</span> <span class="nv">$reflector</span><span class="p">;</span>

  <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">IControllerMethodReflector</span> <span class="nv">$reflector</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">reflector</span> <span class="o">=</span> <span class="nv">$reflector</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="sd">/**</span>
<span class="sd">   * Add custom header if @MyHeader is used</span>
<span class="sd">   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="nf">afterController</span><span class="p">(</span><span class="nv">$controller</span><span class="p">,</span> <span class="nv">$methodName</span><span class="p">,</span> <span class="nx">Response</span> <span class="nv">$response</span><span class="p">)</span><span class="o">:</span> <span class="nx">Response</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">reflector</span><span class="o">-&gt;</span><span class="na">hasAnnotation</span><span class="p">(</span><span class="s1">&#39;MyHeader&#39;</span><span class="p">))</span> <span class="p">{</span>
          <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">addHeader</span><span class="p">(</span><span class="s1">&#39;My-Header&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>An annotation always starts with an uppercase letter</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="controllers.html" class="btn btn-neutral float-left" title="Controllers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="events.html" class="btn btn-neutral float-right" title="Events" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025 Nextcloud GmbH.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="https://docs.nextcloud.com/server/29/developer_manual">29</a></dd>
        
          <dd><a href="https://docs.nextcloud.com/server/30/developer_manual">30</a></dd>
        
          <dd><a href="https://docs.nextcloud.com/server/31/developer_manual">31</a></dd>
        
          <dd><a href="https://docs.nextcloud.com/server/stable/developer_manual">stable</a></dd>
        
          <dd><a href="https://docs.nextcloud.com/server/latest/developer_manual">latest</a></dd>
        
      </dl>
    </div>
  </div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>