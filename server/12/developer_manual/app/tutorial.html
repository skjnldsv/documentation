<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Tutorial &#8212; Nextcloud Developer Manual 12 documentation</title>
    
    <link rel="stylesheet" href="../_static/" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/main.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/styles.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '12',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.1.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Create an app" href="startapp.html" />
    <link rel="prev" title="Changelog" href="changelog.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#1d2d44">
<link rel="shortcut icon" href="https://nextcloud.com/wp-content/themes/next/assets/img/common/favicon.png" />
<link rel="apple-touch-icon-precomposed" href="https://nextcloud.com/wp-content/themes/next/assets/img/common/favicon.png" />
<!-- Piwik -->
<script type="text/javascript">
    var _paq = _paq || [];
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
        var u="//stats.nextcloud.com/";
        _paq.push(['setTrackerUrl', u+'piwik.php']);
        _paq.push(['setSiteId', 3]);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
    })();
</script>
<noscript><p><img src="//stats.nextcloud.com/piwik.php?idsite=3" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->

  </head>
  <body role="document">

<header class="banner navbar navbar-default navbar-static-top" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="brand" href="http://nextcloud.com/" rel="home" title="Nextcloud.com"><img class="logo" src="../_static/img/logo.svg" itemprop="logo"></a>
    </div>

    <nav class="collapse navbar-collapse" role="navigation">
      <ul id="menu-header" class="nav navbar-nav">
          <li><a target="_blank" href="https://demo.nextcloud.com">Demo</a></li>
          <li><a href="https://nextcloud.com/news/">News</a></li>
          <li><a href="https://nextcloud.com/features/">Features</a></li>
          <li><a href="https://nextcloud.com/about/">About us</a></li>
          <li><a href="https://nextcloud.com/contribute/">Get involved</a></li>
          <li><a href="https://nextcloud.com/support/">Support</a></li>
          <li><a href="https://nextcloud.com/enterprise/">Enterprise</a></li>
          <li class="menu-install"><a href="https://nextcloud.com/install/">Download</a></li>
      </ul>
    </nav>
  </div>
</header>




<div class="container" style="background-color: #E6C4C2;color: #b10000;border: #b10000 2px solid;border-right: none;border-left: none;padding: 15px 10px;">You are reading an outdated version of this documentation. Please check out the <a href="https://docs.nextcloud.com/server/stable/developer_manual/" style="
color: rgb(177,0,0);text-decoration: underline;">latest version</a> of the developer manual.</div>





<div class="wrap container not-front">
  <div class="content row">
  <main class="main">
    <div class="row page-content-header">
      <div class="col-md-6">
        <h1><a href="../index.html">Nextcloud Developer Manual</a></h1>
      </div>
      <div class="col-md-5 col-md-offset-1">
      
        <form class="headersearch" style="margin: 16px 0;" action="../search.html" method="get">
        <input type="text" value="" name="q" id="q" class="form-control" /> 
        <button  class="btn btn-default" type="submit" id="searchsubmit">Search</button>
        </form>
      
      </div>
    </div>
    
			<div class="row">
				<div class="col-md-3">
					<div class="sidebar">
							<div class="menu-support-container">
								<ul id="menu-support" class="menu">
									<ul>
										
<li><a href="../index.html">Table of Contents</a></li>
									</ul>
                  <ul>
<li class="toctree-l1"><a class="reference internal" href="../general/index.html">General Contributor Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">App Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/index.html">Design Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../android_library/index.html">Android Application Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../client_apis/index.html">Client APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core/index.html">Core Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bugtracker/index.html">Bugtracker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commun/index.html">Help and Communication</a></li>
</ul>

								</ul>
							</div>
					</div>
				</div>
        

				<div class="col-md-9">
					<div class="page-content">
            
<ul class="prevnext-title list-unstyled list-inline">
  <li class="prev">
    <a href="changelog.html" title="Previous Chapter: Changelog"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm">&laquo; Changelog</span>
    </a>
  </li>
  <li class="next">
    <a href="startapp.html" title="Next Chapter: Create an app"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm">Create an app &raquo;</span>
    </a>
  </li>
</ul>
						
  <div class="section" id="tutorial">
<h1>Tutorial<a class="headerlink" href="#tutorial" title="Permalink to this headline">¶</a></h1>
<p>This tutorial will outline how to create a very simple notes app. The finished app is available on <a class="reference external" href="https://github.com/owncloud/app-tutorial#tutorial">GitHub</a>.</p>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<p>First the <a class="reference internal" href="../general/devenv.html"><span class="doc">development environment</span></a> needs to be set up. This can be done by either <a class="reference external" href="https://nextcloud.com/install/">downloading the zip from the website</a> or cloning it directly from GitHub:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>git clone git@github.com:nextcloud/server.git --branch $BRANCH
cd server
git submodule update --init
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">$BRANCH</span></code> is the desired Nextcloud branch (e.g. <code class="docutils literal"><span class="pre">stable9</span></code> for Nextcloud 9, <code class="docutils literal"><span class="pre">stable10</span></code> for Nextcloud 10, ..., <code class="docutils literal"><span class="pre">master</span></code> for the upcoming release)</p>
</div>
<p>First you want to enable debug mode to get proper error messages. To do that set <code class="docutils literal"><span class="pre">debug</span></code> to <code class="docutils literal"><span class="pre">true</span></code> in the <strong>nextcloud/config/config.php</strong> file:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>&lt;?php
$CONFIG = array (
    &#39;debug&#39; =&gt; true,
    ... configuration goes here ...
);
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">PHP errors are logged to <strong>nextcloud/data/nextcloud.log</strong></p>
</div>
<p>Now open another terminal window and start the development server:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">nextcloud</span>
<span class="n">php</span> <span class="o">-</span><span class="n">S</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">8080</span>
</pre></div>
</div>
<p>Afterwards a skeleton app can be created in the <a class="reference external" href="https://apps.nextcloud.com/developer/apps/generate">app store</a>.</p>
<p>Download the compressed file that contains the generated app and extract it into your <code class="docutils literal"><span class="pre">apps/</span></code> directory. Afterwards the application can be enabled on the <a class="reference external" href="http://localhost:8080/index.php/settings/apps">apps page</a>.</p>
<p>The first basic app is now available at <code class="docutils literal"><span class="pre">http://localhost:8080/index.php/apps/yourappid/</span></code></p>
</div>
<div class="section" id="routes-controllers">
<h2>Routes &amp; Controllers<a class="headerlink" href="#routes-controllers" title="Permalink to this headline">¶</a></h2>
<p>A typical web application consists of server side and client side code. The glue between those two parts are the URLs. In case of the notes app the following URLs will be used:</p>
<ul class="simple">
<li><strong>GET /</strong>: Returns the interface in HTML</li>
<li><strong>GET /notes</strong>: Returns a list of all notes in JSON</li>
<li><strong>GET /notes/1</strong>: Returns a note with the id 1 in JSON</li>
<li><strong>DELETE /notes/1</strong>: Deletes a note with the id 1</li>
<li><strong>POST /notes</strong>: Creates a new note by passing in JSON</li>
<li><strong>PUT /notes/1</strong>: Updates a note with the id 1 by passing in JSON</li>
</ul>
<p>On the client side we can call these URLs with the following jQuery code:</p>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="c1">// example for calling the PUT /notes/1 URL</span>
<span class="kd">var</span> <span class="nx">baseUrl</span> <span class="o">=</span> <span class="nx">OC</span><span class="p">.</span><span class="nx">generateUrl</span><span class="p">(</span><span class="s1">&#39;/apps/ownnotes&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">note</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;New note&#39;</span><span class="p">,</span>
    <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;This is the note text&#39;</span>
<span class="p">};</span>
<span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
    <span class="nx">url</span><span class="o">:</span> <span class="nx">baseUrl</span> <span class="o">+</span> <span class="s1">&#39;/notes/&#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;PUT&#39;</span><span class="p">,</span>
    <span class="nx">contentType</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">note</span><span class="p">)</span>
<span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// handle success</span>
<span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// handle failure</span>
<span class="p">});</span>
</pre></div>
</div>
<p>On the server side we need to register a callback that is executed once the request comes in. The callback itself will be a method on a <a class="reference internal" href="controllers.html"><span class="doc">controller</span></a> and the controller will be connected to the URL with a <a class="reference internal" href="routes.html"><span class="doc">route</span></a>. The controller and route for the page are already set up in <strong>ownnotes/appinfo/routes.php</strong>:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">return</span> <span class="p">[</span><span class="s1">&#39;routes&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;page#index&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;verb&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;GET&#39;</span><span class="p">]</span>
<span class="p">]];</span>
</pre></div>
</div>
<p>This route calls the controller <strong>OCA\OwnNotes\PageController-&gt;index()</strong> method which is defined in <strong>ownnotes/lib/Controller/PageController.php</strong>. The controller returns a <a class="reference internal" href="templates.html"><span class="doc">template</span></a>, in this case <strong>ownnotes/templates/main.php</strong>:</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">&#64;NoAdminRequired and &#64;NoCSRFRequired in the comments above the method turn off security checks, see <a class="reference internal" href="controllers.html"><span class="doc">Controllers</span></a></p>
</div>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
 <span class="k">namespace</span> <span class="nx">OCA\OwnNotes\Controller</span><span class="p">;</span>

 <span class="k">use</span> <span class="nx">OCP\IRequest</span><span class="p">;</span>
 <span class="k">use</span> <span class="nx">OCP\AppFramework\Http\TemplateResponse</span><span class="p">;</span>
 <span class="k">use</span> <span class="nx">OCP\AppFramework\Controller</span><span class="p">;</span>

 <span class="k">class</span> <span class="nc">PageController</span> <span class="k">extends</span> <span class="nx">Controller</span> <span class="p">{</span>

     <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$AppName</span><span class="p">,</span> <span class="nx">IRequest</span> <span class="nv">$request</span><span class="p">){</span>
         <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$AppName</span><span class="p">,</span> <span class="nv">$request</span><span class="p">);</span>
     <span class="p">}</span>

     <span class="sd">/**</span>
<span class="sd">      * @NoAdminRequired</span>
<span class="sd">      * @NoCSRFRequired</span>
<span class="sd">      */</span>
     <span class="k">public</span> <span class="k">function</span> <span class="nf">index</span><span class="p">()</span> <span class="p">{</span>
         <span class="k">return</span> <span class="k">new</span> <span class="nx">TemplateResponse</span><span class="p">(</span><span class="s1">&#39;ownnotes&#39;</span><span class="p">,</span> <span class="s1">&#39;main&#39;</span><span class="p">);</span>
     <span class="p">}</span>

 <span class="p">}</span>
</pre></div>
</div>
<p>Since the route which returns the initial HTML has been taken care of, the controller which handles the AJAX requests for the notes needs to be set up. Create the following file: <strong>ownnotes/lib/Controller/NoteController.php</strong> with the following content:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
 <span class="k">namespace</span> <span class="nx">OCA\OwnNotes\Controller</span><span class="p">;</span>

 <span class="k">use</span> <span class="nx">OCP\IRequest</span><span class="p">;</span>
 <span class="k">use</span> <span class="nx">OCP\AppFramework\Controller</span><span class="p">;</span>

 <span class="k">class</span> <span class="nc">NoteController</span> <span class="k">extends</span> <span class="nx">Controller</span> <span class="p">{</span>

     <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$AppName</span><span class="p">,</span> <span class="nx">IRequest</span> <span class="nv">$request</span><span class="p">){</span>
         <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$AppName</span><span class="p">,</span> <span class="nv">$request</span><span class="p">);</span>
     <span class="p">}</span>

     <span class="sd">/**</span>
<span class="sd">      * @NoAdminRequired</span>
<span class="sd">      */</span>
     <span class="k">public</span> <span class="k">function</span> <span class="nf">index</span><span class="p">()</span> <span class="p">{</span>
         <span class="c1">// empty for now</span>
     <span class="p">}</span>

     <span class="sd">/**</span>
<span class="sd">      * @NoAdminRequired</span>
<span class="sd">      *</span>
<span class="sd">      * @param int $id</span>
<span class="sd">      */</span>
     <span class="k">public</span> <span class="k">function</span> <span class="nf">show</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// empty for now</span>
     <span class="p">}</span>

     <span class="sd">/**</span>
<span class="sd">      * @NoAdminRequired</span>
<span class="sd">      *</span>
<span class="sd">      * @param string $title</span>
<span class="sd">      * @param string $content</span>
<span class="sd">      */</span>
     <span class="k">public</span> <span class="k">function</span> <span class="nf">create</span><span class="p">(</span><span class="nv">$title</span><span class="p">,</span> <span class="nv">$content</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// empty for now</span>
     <span class="p">}</span>

     <span class="sd">/**</span>
<span class="sd">      * @NoAdminRequired</span>
<span class="sd">      *</span>
<span class="sd">      * @param int $id</span>
<span class="sd">      * @param string $title</span>
<span class="sd">      * @param string $content</span>
<span class="sd">      */</span>
     <span class="k">public</span> <span class="k">function</span> <span class="nf">update</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$title</span><span class="p">,</span> <span class="nv">$content</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// empty for now</span>
     <span class="p">}</span>

     <span class="sd">/**</span>
<span class="sd">      * @NoAdminRequired</span>
<span class="sd">      *</span>
<span class="sd">      * @param int $id</span>
<span class="sd">      */</span>
     <span class="k">public</span> <span class="k">function</span> <span class="nf">destroy</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// empty for now</span>
     <span class="p">}</span>

 <span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The parameters are extracted from the request body and the URL using the controller method&#8217;s variable names. Since PHP does not support type hints for primitive types such as ints and booleans, we need to add them as annotations in the comments. In order to type cast a parameter to an int, add <strong>&#64;param int $parameterName</strong></p>
</div>
<p>Now the controller methods need to be connected to the corresponding URLs in the <strong>ownnotes/appinfo/routes.php</strong> file:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">return</span> <span class="p">[</span>
    <span class="s1">&#39;routes&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;page#index&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;verb&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;GET&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;note#index&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/notes&#39;</span><span class="p">,</span> <span class="s1">&#39;verb&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;GET&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;note#show&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/notes/{id}&#39;</span><span class="p">,</span> <span class="s1">&#39;verb&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;GET&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;note#create&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/notes&#39;</span><span class="p">,</span> <span class="s1">&#39;verb&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;POST&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;note#update&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/notes/{id}&#39;</span><span class="p">,</span> <span class="s1">&#39;verb&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;PUT&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;note#destroy&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/notes/{id}&#39;</span><span class="p">,</span> <span class="s1">&#39;verb&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">]</span>
    <span class="p">]</span>
<span class="p">];</span>
</pre></div>
</div>
<p>Since those 5 routes are so common, they can be abbreviated by adding a resource instead:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">return</span> <span class="p">[</span>
    <span class="s1">&#39;resources&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">&#39;note&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;url&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/notes&#39;</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s1">&#39;routes&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;page#index&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;verb&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;GET&#39;</span><span class="p">]</span>
    <span class="p">]</span>
<span class="p">];</span>
</pre></div>
</div>
</div>
<div class="section" id="database">
<h2>Database<a class="headerlink" href="#database" title="Permalink to this headline">¶</a></h2>
<p>Now that the routes are set up and connected the notes should be saved in the database. To do that first create a <a class="reference internal" href="schema.html"><span class="doc">database schema</span></a> by creating <strong>ownnotes/appinfo/database.xml</strong>:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;database&gt;</span>
    <span class="nt">&lt;name&gt;</span>*dbname*<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;create&gt;</span>true<span class="nt">&lt;/create&gt;</span>
    <span class="nt">&lt;overwrite&gt;</span>false<span class="nt">&lt;/overwrite&gt;</span>
    <span class="nt">&lt;charset&gt;</span>utf8<span class="nt">&lt;/charset&gt;</span>
    <span class="nt">&lt;table&gt;</span>
        <span class="nt">&lt;name&gt;</span>*dbprefix*ownnotes_notes<span class="nt">&lt;/name&gt;</span>
        <span class="nt">&lt;declaration&gt;</span>
            <span class="nt">&lt;field&gt;</span>
                <span class="nt">&lt;name&gt;</span>id<span class="nt">&lt;/name&gt;</span>
                <span class="nt">&lt;type&gt;</span>integer<span class="nt">&lt;/type&gt;</span>
                <span class="nt">&lt;notnull&gt;</span>true<span class="nt">&lt;/notnull&gt;</span>
                <span class="nt">&lt;autoincrement&gt;</span>true<span class="nt">&lt;/autoincrement&gt;</span>
                <span class="nt">&lt;unsigned&gt;</span>true<span class="nt">&lt;/unsigned&gt;</span>
                <span class="nt">&lt;primary&gt;</span>true<span class="nt">&lt;/primary&gt;</span>
                <span class="nt">&lt;length&gt;</span>8<span class="nt">&lt;/length&gt;</span>
            <span class="nt">&lt;/field&gt;</span>
            <span class="nt">&lt;field&gt;</span>
                <span class="nt">&lt;name&gt;</span>title<span class="nt">&lt;/name&gt;</span>
                <span class="nt">&lt;type&gt;</span>text<span class="nt">&lt;/type&gt;</span>
                <span class="nt">&lt;length&gt;</span>200<span class="nt">&lt;/length&gt;</span>
                <span class="nt">&lt;default&gt;&lt;/default&gt;</span>
                <span class="nt">&lt;notnull&gt;</span>true<span class="nt">&lt;/notnull&gt;</span>
            <span class="nt">&lt;/field&gt;</span>
            <span class="nt">&lt;field&gt;</span>
                <span class="nt">&lt;name&gt;</span>user_id<span class="nt">&lt;/name&gt;</span>
                <span class="nt">&lt;type&gt;</span>text<span class="nt">&lt;/type&gt;</span>
                <span class="nt">&lt;length&gt;</span>200<span class="nt">&lt;/length&gt;</span>
                <span class="nt">&lt;default&gt;&lt;/default&gt;</span>
                <span class="nt">&lt;notnull&gt;</span>true<span class="nt">&lt;/notnull&gt;</span>
            <span class="nt">&lt;/field&gt;</span>
            <span class="nt">&lt;field&gt;</span>
                <span class="nt">&lt;name&gt;</span>content<span class="nt">&lt;/name&gt;</span>
                <span class="nt">&lt;type&gt;</span>clob<span class="nt">&lt;/type&gt;</span>
                <span class="nt">&lt;default&gt;&lt;/default&gt;</span>
                <span class="nt">&lt;notnull&gt;</span>true<span class="nt">&lt;/notnull&gt;</span>
            <span class="nt">&lt;/field&gt;</span>
        <span class="nt">&lt;/declaration&gt;</span>
    <span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/database&gt;</span>
</pre></div>
</div>
<p>To create the tables in the database, the <a class="reference internal" href="info.html"><span class="doc">version tag</span></a> in <strong>ownnotes/appinfo/info.xml</strong> needs to be increased:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="nt">&lt;info&gt;</span>
    <span class="nt">&lt;id&gt;</span>ownnotes<span class="nt">&lt;/id&gt;</span>
    <span class="nt">&lt;name&gt;</span>Own Notes<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;description&gt;</span>My first Nextcloud app<span class="nt">&lt;/description&gt;</span>
    <span class="nt">&lt;licence&gt;</span>AGPL<span class="nt">&lt;/licence&gt;</span>
    <span class="nt">&lt;author&gt;</span>Your Name<span class="nt">&lt;/author&gt;</span>
    <span class="nt">&lt;version&gt;</span>0.0.2<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;namespace&gt;</span>OwnNotes<span class="nt">&lt;/namespace&gt;</span>
    <span class="nt">&lt;category&gt;</span>tool<span class="nt">&lt;/category&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;owncloud</span> <span class="na">min-version=</span><span class="s">&quot;8&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/info&gt;</span>
</pre></div>
</div>
<p>Reload the page to trigger the database migration.</p>
<p>Now that the tables are created we want to map the database result to a PHP object to be able to control data. First create an <a class="reference internal" href="database.html"><span class="doc">entity</span></a> in <strong>ownnotes/lib/Db/Note.php</strong>:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">OCA\OwnNotes\Db</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">JsonSerializable</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCP\AppFramework\Db\Entity</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Note</span> <span class="k">extends</span> <span class="nx">Entity</span> <span class="k">implements</span> <span class="nx">JsonSerializable</span> <span class="p">{</span>

    <span class="k">protected</span> <span class="nv">$title</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$content</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$userId</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">jsonSerialize</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">title</span><span class="p">,</span>
            <span class="s1">&#39;content&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">content</span>
        <span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A field <strong>id</strong> is automatically set in the Entity base class</p>
</div>
<p>We also define a <strong>jsonSerializable</strong> method and implement the interface to be able to transform the entity to JSON easily.</p>
<p>Entities are returned from so called <a class="reference internal" href="database.html"><span class="doc">Mappers</span></a>. Let&#8217;s create one in <strong>ownnotes/lib/Db/NoteMapper.php</strong> and add a <strong>find</strong> and <strong>findAll</strong> method:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">OCA\OwnNotes\Db</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCP\IDbConnection</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\AppFramework\Db\Mapper</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">NoteMapper</span> <span class="k">extends</span> <span class="nx">Mapper</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">IDbConnection</span> <span class="nv">$db</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$db</span><span class="p">,</span> <span class="s1">&#39;ownnotes_notes&#39;</span><span class="p">,</span> <span class="s1">&#39;\OCA\OwnNotes\Db\Note&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$userId</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$sql</span> <span class="o">=</span> <span class="s1">&#39;SELECT * FROM *PREFIX*ownnotes_notes WHERE id = ? AND user_id = ?&#39;</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">findEntity</span><span class="p">(</span><span class="nv">$sql</span><span class="p">,</span> <span class="p">[</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$userId</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">findAll</span><span class="p">(</span><span class="nv">$userId</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$sql</span> <span class="o">=</span> <span class="s1">&#39;SELECT * FROM *PREFIX*ownnotes_notes WHERE user_id = ?&#39;</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">findEntities</span><span class="p">(</span><span class="nv">$sql</span><span class="p">,</span> <span class="p">[</span><span class="nv">$userId</span><span class="p">]);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The first parent constructor parameter is the database layer, the second one is the database table and the third is the entity on which the result should be mapped onto. Insert, delete and update methods are already implemented.</p>
</div>
</div>
<div class="section" id="connect-database-controllers">
<h2>Connect Database &amp; Controllers<a class="headerlink" href="#connect-database-controllers" title="Permalink to this headline">¶</a></h2>
<p>The mapper which provides the database access is finished and can be passed into the controller.</p>
<p>You can pass in the mapper by adding it as a type hinted parameter. Nextcloud will figure out how to <a class="reference internal" href="container.html"><span class="doc">assemble them by itself</span></a>. Additionally we want to know the userId of the currently logged in user. Simply add a <strong>$UserId</strong> parameter to the constructor (case sensitive!). To do that open <strong>ownnotes/lib/Controller/NoteController.php</strong> and change it to the following:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
 <span class="k">namespace</span> <span class="nx">OCA\OwnNotes\Controller</span><span class="p">;</span>

 <span class="k">use</span> <span class="nx">Exception</span><span class="p">;</span>

 <span class="k">use</span> <span class="nx">OCP\IRequest</span><span class="p">;</span>
 <span class="k">use</span> <span class="nx">OCP\AppFramework\Http</span><span class="p">;</span>
 <span class="k">use</span> <span class="nx">OCP\AppFramework\Http\DataResponse</span><span class="p">;</span>
 <span class="k">use</span> <span class="nx">OCP\AppFramework\Controller</span><span class="p">;</span>

 <span class="k">use</span> <span class="nx">OCA\OwnNotes\Db\Note</span><span class="p">;</span>
 <span class="k">use</span> <span class="nx">OCA\OwnNotes\Db\NoteMapper</span><span class="p">;</span>

 <span class="k">class</span> <span class="nc">NoteController</span> <span class="k">extends</span> <span class="nx">Controller</span> <span class="p">{</span>

     <span class="k">private</span> <span class="nv">$mapper</span><span class="p">;</span>
     <span class="k">private</span> <span class="nv">$userId</span><span class="p">;</span>

     <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$AppName</span><span class="p">,</span> <span class="nx">IRequest</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">NoteMapper</span> <span class="nv">$mapper</span><span class="p">,</span> <span class="nv">$UserId</span><span class="p">){</span>
         <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$AppName</span><span class="p">,</span> <span class="nv">$request</span><span class="p">);</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span> <span class="o">=</span> <span class="nv">$mapper</span><span class="p">;</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span> <span class="o">=</span> <span class="nv">$UserId</span><span class="p">;</span>
     <span class="p">}</span>

     <span class="sd">/**</span>
<span class="sd">      * @NoAdminRequired</span>
<span class="sd">      */</span>
     <span class="k">public</span> <span class="k">function</span> <span class="nf">index</span><span class="p">()</span> <span class="p">{</span>
         <span class="k">return</span> <span class="k">new</span> <span class="nx">DataResponse</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span><span class="p">));</span>
     <span class="p">}</span>

     <span class="sd">/**</span>
<span class="sd">      * @NoAdminRequired</span>
<span class="sd">      *</span>
<span class="sd">      * @param int $id</span>
<span class="sd">      */</span>
     <span class="k">public</span> <span class="k">function</span> <span class="nf">show</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">try</span> <span class="p">{</span>
             <span class="k">return</span> <span class="k">new</span> <span class="nx">DataResponse</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span><span class="p">));</span>
         <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
             <span class="k">return</span> <span class="k">new</span> <span class="nx">DataResponse</span><span class="p">([],</span> <span class="nx">Http</span><span class="o">::</span><span class="na">STATUS_NOT_FOUND</span><span class="p">);</span>
         <span class="p">}</span>
     <span class="p">}</span>

     <span class="sd">/**</span>
<span class="sd">      * @NoAdminRequired</span>
<span class="sd">      *</span>
<span class="sd">      * @param string $title</span>
<span class="sd">      * @param string $content</span>
<span class="sd">      */</span>
     <span class="k">public</span> <span class="k">function</span> <span class="nf">create</span><span class="p">(</span><span class="nv">$title</span><span class="p">,</span> <span class="nv">$content</span><span class="p">)</span> <span class="p">{</span>
         <span class="nv">$note</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Note</span><span class="p">();</span>
         <span class="nv">$note</span><span class="o">-&gt;</span><span class="na">setTitle</span><span class="p">(</span><span class="nv">$title</span><span class="p">);</span>
         <span class="nv">$note</span><span class="o">-&gt;</span><span class="na">setContent</span><span class="p">(</span><span class="nv">$content</span><span class="p">);</span>
         <span class="nv">$note</span><span class="o">-&gt;</span><span class="na">setUserId</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span><span class="p">);</span>
         <span class="k">return</span> <span class="k">new</span> <span class="nx">DataResponse</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="nv">$note</span><span class="p">));</span>
     <span class="p">}</span>

     <span class="sd">/**</span>
<span class="sd">      * @NoAdminRequired</span>
<span class="sd">      *</span>
<span class="sd">      * @param int $id</span>
<span class="sd">      * @param string $title</span>
<span class="sd">      * @param string $content</span>
<span class="sd">      */</span>
     <span class="k">public</span> <span class="k">function</span> <span class="nf">update</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$title</span><span class="p">,</span> <span class="nv">$content</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">try</span> <span class="p">{</span>
             <span class="nv">$note</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
             <span class="k">return</span> <span class="k">new</span> <span class="nx">DataResponse</span><span class="p">([],</span> <span class="nx">Http</span><span class="o">::</span><span class="na">STATUS_NOT_FOUND</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="nv">$note</span><span class="o">-&gt;</span><span class="na">setTitle</span><span class="p">(</span><span class="nv">$title</span><span class="p">);</span>
         <span class="nv">$note</span><span class="o">-&gt;</span><span class="na">setContent</span><span class="p">(</span><span class="nv">$content</span><span class="p">);</span>
         <span class="k">return</span> <span class="k">new</span> <span class="nx">DataResponse</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span><span class="nv">$note</span><span class="p">));</span>
     <span class="p">}</span>

     <span class="sd">/**</span>
<span class="sd">      * @NoAdminRequired</span>
<span class="sd">      *</span>
<span class="sd">      * @param int $id</span>
<span class="sd">      */</span>
     <span class="k">public</span> <span class="k">function</span> <span class="nf">destroy</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">try</span> <span class="p">{</span>
             <span class="nv">$note</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
             <span class="k">return</span> <span class="k">new</span> <span class="nx">DataResponse</span><span class="p">([],</span> <span class="nx">Http</span><span class="o">::</span><span class="na">STATUS_NOT_FOUND</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">(</span><span class="nv">$note</span><span class="p">);</span>
         <span class="k">return</span> <span class="k">new</span> <span class="nx">DataResponse</span><span class="p">(</span><span class="nv">$note</span><span class="p">);</span>
     <span class="p">}</span>

 <span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The actual exceptions are <strong>OCP\AppFramework\Db\DoesNotExistException</strong> and <strong>OCP\AppFramework\Db\MultipleObjectsReturnedException</strong> but in this example we will treat them as the same. DataResponse is a more generic response than JSONResponse and also works with JSON.</p>
</div>
<p>This is all that is needed on the server side. Now let&#8217;s progress to the client side.</p>
</div>
<div class="section" id="making-things-reusable-and-decoupling-controllers-from-the-database">
<h2>Making things reusable and decoupling controllers from the database<a class="headerlink" href="#making-things-reusable-and-decoupling-controllers-from-the-database" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s say our app is now on the app store and and we get a request that we should save the files in the filesystem which requires access to the filesystem.</p>
<p>The filesystem API is quite different from the database API and throws different exceptions, which means we need to rewrite everything in the <strong>NoteController</strong> class to use it. This is bad because a controller&#8217;s only responsibility should be to deal with incoming Http requests and return Http responses. If we need to change the controller because the data storage was changed the code is probably too tightly coupled and we need to add another layer in between. This layer is called <strong>Service</strong>.</p>
<p>Let&#8217;s take the logic that was inside the controller and put it into a separate class inside <strong>ownnotes/lib/Service/NoteService.php</strong>:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">OCA\OwnNotes\Service</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Exception</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCP\AppFramework\Db\DoesNotExistException</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\AppFramework\Db\MultipleObjectsReturnedException</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCA\OwnNotes\Db\Note</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCA\OwnNotes\Db\NoteMapper</span><span class="p">;</span>


<span class="k">class</span> <span class="nc">NoteService</span> <span class="p">{</span>

    <span class="k">private</span> <span class="nv">$mapper</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">NoteMapper</span> <span class="nv">$mapper</span><span class="p">){</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span> <span class="o">=</span> <span class="nv">$mapper</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">findAll</span><span class="p">(</span><span class="nv">$userId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">(</span><span class="nv">$userId</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">handleException</span> <span class="p">(</span><span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$e</span> <span class="nx">instanceof</span> <span class="nx">DoesNotExistException</span> <span class="o">||</span>
            <span class="nv">$e</span> <span class="nx">instanceof</span> <span class="nx">MultipleObjectsReturnedException</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">NotFoundException</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$userId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$userId</span><span class="p">);</span>

        <span class="c1">// in order to be able to plug in different storage backends like files</span>
        <span class="c1">// for instance it is a good idea to turn storage related exceptions</span>
        <span class="c1">// into service related exceptions so controllers and service users</span>
        <span class="c1">// have to deal with only one type of exception</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handleException</span><span class="p">(</span><span class="nv">$e</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">create</span><span class="p">(</span><span class="nv">$title</span><span class="p">,</span> <span class="nv">$content</span><span class="p">,</span> <span class="nv">$userId</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$note</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Note</span><span class="p">();</span>
        <span class="nv">$note</span><span class="o">-&gt;</span><span class="na">setTitle</span><span class="p">(</span><span class="nv">$title</span><span class="p">);</span>
        <span class="nv">$note</span><span class="o">-&gt;</span><span class="na">setContent</span><span class="p">(</span><span class="nv">$content</span><span class="p">);</span>
        <span class="nv">$note</span><span class="o">-&gt;</span><span class="na">setUserId</span><span class="p">(</span><span class="nv">$userId</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="nv">$note</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">update</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$title</span><span class="p">,</span> <span class="nv">$content</span><span class="p">,</span> <span class="nv">$userId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$note</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$userId</span><span class="p">);</span>
            <span class="nv">$note</span><span class="o">-&gt;</span><span class="na">setTitle</span><span class="p">(</span><span class="nv">$title</span><span class="p">);</span>
            <span class="nv">$note</span><span class="o">-&gt;</span><span class="na">setContent</span><span class="p">(</span><span class="nv">$content</span><span class="p">);</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span><span class="nv">$note</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handleException</span><span class="p">(</span><span class="nv">$e</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">delete</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$userId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$note</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$userId</span><span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">(</span><span class="nv">$note</span><span class="p">);</span>
            <span class="k">return</span> <span class="nv">$note</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handleException</span><span class="p">(</span><span class="nv">$e</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Following up create the exceptions in <strong>ownnotes/lib/Service/ServiceException.php</strong>:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">OCA\OwnNotes\Service</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Exception</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ServiceException</span> <span class="k">extends</span> <span class="nx">Exception</span> <span class="p">{}</span>
</pre></div>
</div>
<p>and <strong>ownnotes/lib/Service/NotFoundException.php</strong>:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">OCA\OwnNotes\Service</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">NotFoundException</span> <span class="k">extends</span> <span class="nx">ServiceException</span> <span class="p">{}</span>
</pre></div>
</div>
<p>Remember how we had all those ugly try catches that where checking for <strong>DoesNotExistException</strong> and simply returned a 404 response? Let&#8217;s also put this into a reusable class. In our case we chose a <a class="reference external" href="http://php.net/manual/en/language.oop5.traits.php">trait</a> so we can inherit methods without having to add it to our inheritance hierarchy. This will be important later on when you&#8217;ve got controllers that inherit from the <strong>ApiController</strong> class instead.</p>
<p>The trait is created in <strong>ownnotes/lib/Controller/Errors.php</strong>:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">OCA\OwnNotes\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Closure</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCP\AppFramework\Http</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\AppFramework\Http\DataResponse</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCA\OwnNotes\Service\NotFoundException</span><span class="p">;</span>


<span class="k">trait</span> <span class="nx">Errors</span> <span class="p">{</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">handleNotFound</span> <span class="p">(</span><span class="nx">Closure</span> <span class="nv">$callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">DataResponse</span><span class="p">(</span><span class="nv">$callback</span><span class="p">());</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">NotFoundException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$message</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()];</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">DataResponse</span><span class="p">(</span><span class="nv">$message</span><span class="p">,</span> <span class="nx">Http</span><span class="o">::</span><span class="na">STATUS_NOT_FOUND</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Now we can wire up the trait and the service inside the <strong>NoteController</strong>:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">OCA\OwnNotes\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCP\IRequest</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\AppFramework\Http\DataResponse</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\AppFramework\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCA\OwnNotes\Service\NoteService</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">NoteController</span> <span class="k">extends</span> <span class="nx">Controller</span> <span class="p">{</span>

    <span class="k">private</span> <span class="nv">$service</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$userId</span><span class="p">;</span>

    <span class="k">use</span> <span class="nx">Errors</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$AppName</span><span class="p">,</span> <span class="nx">IRequest</span> <span class="nv">$request</span><span class="p">,</span>
                                <span class="nx">NoteService</span> <span class="nv">$service</span><span class="p">,</span> <span class="nv">$UserId</span><span class="p">){</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$AppName</span><span class="p">,</span> <span class="nv">$request</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span> <span class="o">=</span> <span class="nv">$service</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span> <span class="o">=</span> <span class="nv">$UserId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @NoAdminRequired</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">index</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">DataResponse</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @NoAdminRequired</span>
<span class="sd">     *</span>
<span class="sd">     * @param int $id</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">show</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handleNotFound</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @NoAdminRequired</span>
<span class="sd">     *</span>
<span class="sd">     * @param string $title</span>
<span class="sd">     * @param string $content</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">create</span><span class="p">(</span><span class="nv">$title</span><span class="p">,</span> <span class="nv">$content</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="nv">$title</span><span class="p">,</span> <span class="nv">$content</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @NoAdminRequired</span>
<span class="sd">     *</span>
<span class="sd">     * @param int $id</span>
<span class="sd">     * @param string $title</span>
<span class="sd">     * @param string $content</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">update</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$title</span><span class="p">,</span> <span class="nv">$content</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handleNotFound</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$title</span><span class="p">,</span> <span class="nv">$content</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$title</span><span class="p">,</span> <span class="nv">$content</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @NoAdminRequired</span>
<span class="sd">     *</span>
<span class="sd">     * @param int $id</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">destroy</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handleNotFound</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Great! Now the only reason that the controller needs to be changed is when request/response related things change.</p>
</div>
<div class="section" id="writing-a-test-for-the-controller-recommended">
<h2>Writing a test for the controller (recommended)<a class="headerlink" href="#writing-a-test-for-the-controller-recommended" title="Permalink to this headline">¶</a></h2>
<p>Tests are essential for having happy users and a carefree life. No one wants their users to rant about your app breaking their Nextcloud or being buggy. To do that you need to test your app. Since this amounts to a ton of repetitive tasks, we need to automate the tests.</p>
<div class="section" id="unit-tests">
<h3>Unit Tests<a class="headerlink" href="#unit-tests" title="Permalink to this headline">¶</a></h3>
<p>A unit test is a test that tests a class in isolation. It is very fast and catches most of the bugs, so we want many unit tests.</p>
<p>Because Nextcloud uses <a class="reference internal" href="container.html"><span class="doc">Dependency Injection</span></a> to assemble your app, it is very easy to write unit tests by passing mocks into the constructor. A simple test for the update method can be added by adding this to <strong>ownnotes/tests/Unit/Controller/NoteControllerTest.php</strong>:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">OCA\OwnNotes\Tests\Unit\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">PHPUnit_Framework_TestCase</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCP\AppFramework\Http</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\AppFramework\Http\DataResponse</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCA\OwnNotes\Service\NotFoundException</span><span class="p">;</span>


<span class="k">class</span> <span class="nc">NoteControllerTest</span> <span class="k">extends</span> <span class="nx">PHPUnit_Framework_TestCase</span> <span class="p">{</span>

    <span class="k">protected</span> <span class="nv">$controller</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$service</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$userId</span> <span class="o">=</span> <span class="s1">&#39;john&#39;</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$request</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getMockBuilder</span><span class="p">(</span><span class="s1">&#39;OCP\IRequest&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getMock</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getMockBuilder</span><span class="p">(</span><span class="s1">&#39;OCA\OwnNotes\Service\NoteService&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">disableOriginalConstructor</span><span class="p">()</span>
            <span class="o">-&gt;</span><span class="na">getMock</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NoteController</span><span class="p">(</span>
            <span class="s1">&#39;ownnotes&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testUpdate</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$note</span> <span class="o">=</span> <span class="s1">&#39;just check if this value is returned correctly&#39;</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="o">-&gt;</span><span class="na">expects</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">once</span><span class="p">())</span>
            <span class="o">-&gt;</span><span class="na">method</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">with</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">equalTo</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">equalTo</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">),</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">equalTo</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">),</span>
                   <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">equalTo</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span><span class="p">))</span>
            <span class="o">-&gt;</span><span class="na">will</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">returnValue</span><span class="p">(</span><span class="nv">$note</span><span class="p">));</span>

        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">controller</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="nv">$note</span><span class="p">,</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">());</span>
    <span class="p">}</span>


    <span class="k">public</span> <span class="k">function</span> <span class="nf">testUpdateNotFound</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// test the correct status code if no note is found</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="o">-&gt;</span><span class="na">expects</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">once</span><span class="p">())</span>
            <span class="o">-&gt;</span><span class="na">method</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">will</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">throwException</span><span class="p">(</span><span class="k">new</span> <span class="nx">NotFoundException</span><span class="p">()));</span>

        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">controller</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="nx">Http</span><span class="o">::</span><span class="na">STATUS_NOT_FOUND</span><span class="p">,</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">getStatus</span><span class="p">());</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>We can and should also create a test for the <strong>NoteService</strong> class:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">OCA\OwnNotes\Tests\Unit\Service</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">PHPUnit_Framework_TestCase</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCP\AppFramework\Db\DoesNotExistException</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCA\OwnNotes\Db\Note</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">NoteServiceTest</span> <span class="k">extends</span> <span class="nx">PHPUnit_Framework_TestCase</span> <span class="p">{</span>

    <span class="k">private</span> <span class="nv">$service</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$mapper</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$userId</span> <span class="o">=</span> <span class="s1">&#39;john&#39;</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getMockBuilder</span><span class="p">(</span><span class="s1">&#39;OCA\OwnNotes\Db\NoteMapper&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">disableOriginalConstructor</span><span class="p">()</span>
            <span class="o">-&gt;</span><span class="na">getMock</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NoteService</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testUpdate</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// the existing note</span>
        <span class="nv">$note</span> <span class="o">=</span> <span class="nx">Note</span><span class="o">::</span><span class="na">fromRow</span><span class="p">([</span>
            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;yo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;content&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;nope&#39;</span>
        <span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span><span class="o">-&gt;</span><span class="na">expects</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">once</span><span class="p">())</span>
            <span class="o">-&gt;</span><span class="na">method</span><span class="p">(</span><span class="s1">&#39;find&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">with</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">equalTo</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
            <span class="o">-&gt;</span><span class="na">will</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">returnValue</span><span class="p">(</span><span class="nv">$note</span><span class="p">));</span>

        <span class="c1">// the note when updated</span>
        <span class="nv">$updatedNote</span> <span class="o">=</span> <span class="nx">Note</span><span class="o">::</span><span class="na">fromRow</span><span class="p">([</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">]);</span>
        <span class="nv">$updatedNote</span><span class="o">-&gt;</span><span class="na">setTitle</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">);</span>
        <span class="nv">$updatedNote</span><span class="o">-&gt;</span><span class="na">setContent</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span><span class="o">-&gt;</span><span class="na">expects</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">once</span><span class="p">())</span>
            <span class="o">-&gt;</span><span class="na">method</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">with</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">equalTo</span><span class="p">(</span><span class="nv">$updatedNote</span><span class="p">))</span>
            <span class="o">-&gt;</span><span class="na">will</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">returnValue</span><span class="p">(</span><span class="nv">$updatedNote</span><span class="p">));</span>

        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="nv">$updatedNote</span><span class="p">,</span> <span class="nv">$result</span><span class="p">);</span>
    <span class="p">}</span>


    <span class="sd">/**</span>
<span class="sd">     * @expectedException OCA\OwnNotes\Service\NotFoundException</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">testUpdateNotFound</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// test the correct status code if no note is found</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span><span class="o">-&gt;</span><span class="na">expects</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">once</span><span class="p">())</span>
            <span class="o">-&gt;</span><span class="na">method</span><span class="p">(</span><span class="s1">&#39;find&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">with</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">equalTo</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
            <span class="o">-&gt;</span><span class="na">will</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">throwException</span><span class="p">(</span><span class="k">new</span> <span class="nx">DoesNotExistException</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)));</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>If <a class="reference external" href="https://phpunit.de/">PHPUnit is installed</a> we can run the tests inside <strong>ownnotes/</strong> with the following command:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">phpunit</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You need to adjust the <strong>ownnotes/tests/Unit/Controller/PageControllerTest</strong> file to get the tests passing: remove the <strong>testEcho</strong> method since that method is no longer present in your <strong>PageController</strong> and do not test the user id parameters since they are not passed anymore</p>
</div>
</div>
<div class="section" id="integration-tests">
<h3>Integration Tests<a class="headerlink" href="#integration-tests" title="Permalink to this headline">¶</a></h3>
<p>Integration tests are slow and need a fully working instance but make sure that our classes work well together. Instead of mocking out all classes and parameters we can decide whether to use full instances or replace certain classes. Because they are slow we don&#8217;t want as many integration tests as unit tests.</p>
<p>In our case we want to create an integration test for the udpate method without mocking out the <strong>NoteMapper</strong> class so we actually write to the existing database.</p>
<p>To do that create a new file called <strong>ownnotes/tests/Integration/NoteIntegrationTest.php</strong> with the following content:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">OCA\OwnNotes\Tests\Integration\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCP\AppFramework\Http\DataResponse</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\AppFramework\App</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Test\TestCase</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCA\OwnNotes\Db\Note</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * @group DB</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">NoteIntegrationTest</span> <span class="k">extends</span> <span class="nx">TestCase</span> <span class="p">{</span>

    <span class="k">private</span> <span class="nv">$controller</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$mapper</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$userId</span> <span class="o">=</span> <span class="s1">&#39;john&#39;</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">setUp</span><span class="p">();</span>
        <span class="nv">$app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">(</span><span class="s1">&#39;ownnotes&#39;</span><span class="p">);</span>
        <span class="nv">$container</span> <span class="o">=</span> <span class="nv">$app</span><span class="o">-&gt;</span><span class="na">getContainer</span><span class="p">();</span>

        <span class="c1">// only replace the user id</span>
        <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">registerService</span><span class="p">(</span><span class="s1">&#39;UserId&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="nv">$c</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span><span class="p">;</span>
        <span class="p">});</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">controller</span> <span class="o">=</span> <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span>
            <span class="s1">&#39;OCA\OwnNotes\Controller\NoteController&#39;</span>
        <span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span> <span class="o">=</span> <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span>
            <span class="s1">&#39;OCA\OwnNotes\Db\NoteMapper&#39;</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testUpdate</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// create a new note that should be updated</span>
        <span class="nv">$note</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Note</span><span class="p">();</span>
        <span class="nv">$note</span><span class="o">-&gt;</span><span class="na">setTitle</span><span class="p">(</span><span class="s1">&#39;old_title&#39;</span><span class="p">);</span>
        <span class="nv">$note</span><span class="o">-&gt;</span><span class="na">setContent</span><span class="p">(</span><span class="s1">&#39;old_content&#39;</span><span class="p">);</span>
        <span class="nv">$note</span><span class="o">-&gt;</span><span class="na">setUserId</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span><span class="p">);</span>

        <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="nv">$note</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">();</span>

        <span class="c1">// fromRow does not set the fields as updated</span>
        <span class="nv">$updatedNote</span> <span class="o">=</span> <span class="nx">Note</span><span class="o">::</span><span class="na">fromRow</span><span class="p">([</span>
            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">,</span>
            <span class="s1">&#39;user_id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span>
        <span class="p">]);</span>
        <span class="nv">$updatedNote</span><span class="o">-&gt;</span><span class="na">setContent</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">);</span>
        <span class="nv">$updatedNote</span><span class="o">-&gt;</span><span class="na">setTitle</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">);</span>

        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">controller</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="nv">$updatedNote</span><span class="p">,</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">());</span>

        <span class="c1">// clean up</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">(</span><span class="nv">$result</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">());</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>To run the integration tests change into the <strong>ownnotes</strong> directory and run:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">phpunit</span> <span class="o">-</span><span class="n">c</span> <span class="n">phpunit</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">xml</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="adding-a-restful-api-optional">
<h2>Adding a RESTful API (optional)<a class="headerlink" href="#adding-a-restful-api-optional" title="Permalink to this headline">¶</a></h2>
<p>A <a class="reference internal" href="api.html"><span class="doc">RESTful API</span></a> allows other apps such as Android or iPhone apps to access and change your notes. Since syncing is a big core component of Nextcloud it is a good idea to add (and document!) your own RESTful API.</p>
<p>Because we put our logic into the <strong>NoteService</strong> class it is very easy to reuse it. The only pieces that need to be changed are the annotations which disable the CSRF check (not needed for a REST call usually) and add support for <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS">CORS</a> so your API can be accessed from other webapps.</p>
<p>With that in mind create a new controller in <strong>ownnotes/lib/Controller/NoteApiController.php</strong>:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">OCA\OwnNotes\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCP\IRequest</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\AppFramework\Http\DataResponse</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">OCP\AppFramework\ApiController</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">OCA\OwnNotes\Service\NoteService</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">NoteApiController</span> <span class="k">extends</span> <span class="nx">ApiController</span> <span class="p">{</span>

    <span class="k">private</span> <span class="nv">$service</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$userId</span><span class="p">;</span>

    <span class="k">use</span> <span class="nx">Errors</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$AppName</span><span class="p">,</span> <span class="nx">IRequest</span> <span class="nv">$request</span><span class="p">,</span>
                                <span class="nx">NoteService</span> <span class="nv">$service</span><span class="p">,</span> <span class="nv">$UserId</span><span class="p">){</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$AppName</span><span class="p">,</span> <span class="nv">$request</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span> <span class="o">=</span> <span class="nv">$service</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span> <span class="o">=</span> <span class="nv">$UserId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @CORS</span>
<span class="sd">     * @NoCSRFRequired</span>
<span class="sd">     * @NoAdminRequired</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">index</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">DataResponse</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @CORS</span>
<span class="sd">     * @NoCSRFRequired</span>
<span class="sd">     * @NoAdminRequired</span>
<span class="sd">     *</span>
<span class="sd">     * @param int $id</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">show</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handleNotFound</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @CORS</span>
<span class="sd">     * @NoCSRFRequired</span>
<span class="sd">     * @NoAdminRequired</span>
<span class="sd">     *</span>
<span class="sd">     * @param string $title</span>
<span class="sd">     * @param string $content</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">create</span><span class="p">(</span><span class="nv">$title</span><span class="p">,</span> <span class="nv">$content</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="nv">$title</span><span class="p">,</span> <span class="nv">$content</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @CORS</span>
<span class="sd">     * @NoCSRFRequired</span>
<span class="sd">     * @NoAdminRequired</span>
<span class="sd">     *</span>
<span class="sd">     * @param int $id</span>
<span class="sd">     * @param string $title</span>
<span class="sd">     * @param string $content</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">update</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$title</span><span class="p">,</span> <span class="nv">$content</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handleNotFound</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$title</span><span class="p">,</span> <span class="nv">$content</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$title</span><span class="p">,</span> <span class="nv">$content</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @CORS</span>
<span class="sd">     * @NoCSRFRequired</span>
<span class="sd">     * @NoAdminRequired</span>
<span class="sd">     *</span>
<span class="sd">     * @param int $id</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">destroy</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handleNotFound</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>All that is left is to connect the controller to a route and enable the built in preflighted CORS method which is defined in the <strong>ApiController</strong> base class:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">return</span> <span class="p">[</span>
    <span class="s1">&#39;resources&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">&#39;note&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;url&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/notes&#39;</span><span class="p">],</span>
        <span class="s1">&#39;note_api&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;url&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/api/0.1/notes&#39;</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s1">&#39;routes&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;page#index&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;verb&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;GET&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;note_api#preflighted_cors&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/api/0.1/{path}&#39;</span><span class="p">,</span>
         <span class="s1">&#39;verb&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">,</span> <span class="s1">&#39;requirements&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;.+&#39;</span><span class="p">]]</span>
    <span class="p">]</span>
<span class="p">];</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is a good idea to version your API in your URL</p>
</div>
<p>You can test the API by running a GET request with <strong>curl</strong>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">u</span> <span class="n">user</span><span class="p">:</span><span class="n">password</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8080</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">ownnotes</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="mf">0.1</span><span class="o">/</span><span class="n">notes</span>
</pre></div>
</div>
<p>Since the <strong>NoteApiController</strong> is basically identical to the <strong>NoteController</strong>, the unit test for it simply inherits its tests from the <strong>NoteControllerTest</strong>. Create the file <strong>ownnotes/tests/Unit/Controller/NoteApiControllerTest.php</strong>:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">OCA\OwnNotes\Tests\Unit\Controller</span><span class="p">;</span>

<span class="k">require_once</span> <span class="no">__DIR__</span> <span class="o">.</span> <span class="s1">&#39;/NoteControllerTest.php&#39;</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">NoteApiControllerTest</span> <span class="k">extends</span> <span class="nx">NoteControllerTest</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">setUp</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NoteApiController</span><span class="p">(</span>
            <span class="s1">&#39;ownnotes&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userId</span>
        <span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="adding-javascript-and-css">
<h2>Adding JavaScript and CSS<a class="headerlink" href="#adding-javascript-and-css" title="Permalink to this headline">¶</a></h2>
<p>To create a modern webapp you need to write <a class="reference internal" href="js.html"><span class="doc">JavaScript</span></a>. You can use any JavaScript framework but for this tutorial we want to keep it as simple as possible and therefore only include the templating library <a class="reference external" href="http://handlebarsjs.com/">handlebarsjs</a>. <a class="reference external" href="http://builds.handlebarsjs.com.s3.amazonaws.com/handlebars-v2.0.0.js">Download the file</a> into <strong>ownnotes/js/handlebars.js</strong> and include it at the very top of <strong>ownnotes/templates/main.php</strong> before the other scripts and styles:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nx">script</span><span class="p">(</span><span class="s1">&#39;ownnotes&#39;</span><span class="p">,</span> <span class="s1">&#39;handlebars&#39;</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">jQuery is included by default on every page.</p>
</div>
</div>
<div class="section" id="creating-a-navigation">
<h2>Creating a navigation<a class="headerlink" href="#creating-a-navigation" title="Permalink to this headline">¶</a></h2>
<p>The template file <strong>ownnotes/templates/part.navigation.php</strong> contains the navigation. Nextcloud defines many handy <a class="reference internal" href="css.html"><span class="doc">CSS styles</span></a> which we are going to reuse to style the navigation. Adjust the file to contain only the following code:</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><strong>$l-&gt;t()</strong> is used to make your strings <a class="reference internal" href="l10n.html"><span class="doc">translatable</span></a> and <strong>p()</strong> is used <a class="reference internal" href="templates.html"><span class="doc">to print escaped HTML</span></a></p>
</div>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="x">&lt;!-- translation strings --&gt;</span>
<span class="x">&lt;div style=&quot;display:none&quot; id=&quot;new-note-string&quot;&gt;</span><span class="cp">&lt;?php</span> <span class="nx">p</span><span class="p">(</span><span class="nv">$l</span><span class="o">-&gt;</span><span class="na">t</span><span class="p">(</span><span class="s1">&#39;New note&#39;</span><span class="p">));</span> <span class="cp">?&gt;</span><span class="x">&lt;/div&gt;</span>

<span class="x">&lt;script id=&quot;navigation-tpl&quot; type=&quot;text/x-handlebars-template&quot;&gt;</span>
<span class="x">    &lt;li id=&quot;new-note&quot;&gt;&lt;a href=&quot;#&quot;&gt;</span><span class="cp">&lt;?php</span> <span class="nx">p</span><span class="p">(</span><span class="nv">$l</span><span class="o">-&gt;</span><span class="na">t</span><span class="p">(</span><span class="s1">&#39;Add note&#39;</span><span class="p">));</span> <span class="cp">?&gt;</span><span class="x">&lt;/a&gt;&lt;/li&gt;</span>
<span class="x">    {{#each notes}}</span>
<span class="x">        &lt;li class=&quot;note with-menu {{#if active}}active{{/if}}&quot; data-id=&quot;{{ id }}&quot;&gt;</span>
<span class="x">            &lt;a href=&quot;#&quot;&gt;{{ title }}&lt;/a&gt;</span>
<span class="x">            &lt;div class=&quot;app-navigation-entry-utils&quot;&gt;</span>
<span class="x">                &lt;ul&gt;</span>
<span class="x">                    &lt;li class=&quot;app-navigation-entry-utils-menu-button svg&quot;&gt;&lt;button&gt;&lt;/button&gt;&lt;/li&gt;</span>
<span class="x">                &lt;/ul&gt;</span>
<span class="x">            &lt;/div&gt;</span>

<span class="x">            &lt;div class=&quot;app-navigation-entry-menu&quot;&gt;</span>
<span class="x">                &lt;ul&gt;</span>
<span class="x">                    &lt;li&gt;&lt;button class=&quot;delete icon-delete svg&quot; title=&quot;delete&quot;&gt;&lt;/button&gt;&lt;/li&gt;</span>
<span class="x">                &lt;/ul&gt;</span>
<span class="x">            &lt;/div&gt;</span>
<span class="x">        &lt;/li&gt;</span>
<span class="x">    {{/each}}</span>
<span class="x">&lt;/script&gt;</span>

<span class="x">&lt;ul&gt;&lt;/ul&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-the-content">
<h2>Creating the content<a class="headerlink" href="#creating-the-content" title="Permalink to this headline">¶</a></h2>
<p>The template file <strong>ownnotes/templates/part.content.php</strong> contains the content. It will just be a textarea and a button, so replace the content with the following:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="x">&lt;script id=&quot;content-tpl&quot; type=&quot;text/x-handlebars-template&quot;&gt;</span>
<span class="x">    {{#if note}}</span>
<span class="x">        &lt;div class=&quot;input&quot;&gt;&lt;textarea&gt;{{ note.content }}&lt;/textarea&gt;&lt;/div&gt;</span>
<span class="x">        &lt;div class=&quot;save&quot;&gt;&lt;button&gt;</span><span class="cp">&lt;?php</span> <span class="nx">p</span><span class="p">(</span><span class="nv">$l</span><span class="o">-&gt;</span><span class="na">t</span><span class="p">(</span><span class="s1">&#39;Save&#39;</span><span class="p">));</span> <span class="cp">?&gt;</span><span class="x">&lt;/button&gt;&lt;/div&gt;</span>
<span class="x">    {{else}}</span>
<span class="x">        &lt;div class=&quot;input&quot;&gt;&lt;textarea disabled&gt;&lt;/textarea&gt;&lt;/div&gt;</span>
<span class="x">        &lt;div class=&quot;save&quot;&gt;&lt;button disabled&gt;</span><span class="cp">&lt;?php</span> <span class="nx">p</span><span class="p">(</span><span class="nv">$l</span><span class="o">-&gt;</span><span class="na">t</span><span class="p">(</span><span class="s1">&#39;Save&#39;</span><span class="p">));</span> <span class="cp">?&gt;</span><span class="x">&lt;/button&gt;&lt;/div&gt;</span>
<span class="x">    {{/if}}</span>
<span class="x">&lt;/script&gt;</span>
<span class="x">&lt;div id=&quot;editor&quot;&gt;&lt;/div&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="wiring-it-up">
<h2>Wiring it up<a class="headerlink" href="#wiring-it-up" title="Permalink to this headline">¶</a></h2>
<p>When the page is loaded we want all the existing notes to load. Furthermore we want to display the current note when you click on it in the navigation, a note should be deleted when we click the deleted button and clicking on <strong>New note</strong> should create a new note. To do that open <strong>ownnotes/js/script.js</strong> and replace the example code with the following:</p>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">OC</span><span class="p">,</span> <span class="nb">window</span><span class="p">,</span> <span class="nx">$</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
<span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

<span class="kd">var</span> <span class="nx">translations</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">newNote</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#new-note-string&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">()</span>
<span class="p">};</span>

<span class="c1">// this notes object holds all our notes</span>
<span class="kd">var</span> <span class="nx">Notes</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">baseUrl</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_baseUrl</span> <span class="o">=</span> <span class="nx">baseUrl</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_notes</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_activeNote</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">Notes</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">load</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_notes</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">note</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">note</span><span class="p">.</span><span class="nx">active</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">_activeNote</span> <span class="o">=</span> <span class="nx">note</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">note</span><span class="p">.</span><span class="nx">active</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">},</span>
    <span class="nx">getActive</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_activeNote</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">removeActive</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">index</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_activeNote</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_notes</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">note</span><span class="p">,</span> <span class="nx">counter</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">index</span> <span class="o">=</span> <span class="nx">counter</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// delete cached active note if necessary</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_activeNote</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">_notes</span><span class="p">[</span><span class="nx">index</span><span class="p">])</span> <span class="p">{</span>
                <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">_activeNote</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">_notes</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

            <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
                <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_baseUrl</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">,</span>
                <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;DELETE&#39;</span>
            <span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
            <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">();</span>
            <span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="nx">create</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">note</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
            <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_baseUrl</span><span class="p">,</span>
            <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
            <span class="nx">contentType</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
            <span class="nx">data</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">note</span><span class="p">)</span>
        <span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">note</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">_notes</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">note</span><span class="p">);</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">_activeNote</span> <span class="o">=</span> <span class="nx">note</span><span class="p">;</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
            <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
        <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">();</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="nx">getAll</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_notes</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">loadAll</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_baseUrl</span><span class="p">).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">notes</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">_activeNote</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">_notes</span> <span class="o">=</span> <span class="nx">notes</span><span class="p">;</span>
            <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
        <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">();</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="nx">updateActive</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">title</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">note</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getActive</span><span class="p">();</span>
        <span class="nx">note</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">title</span><span class="p">;</span>
        <span class="nx">note</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">content</span><span class="p">;</span>

        <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
            <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_baseUrl</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
            <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;PUT&#39;</span><span class="p">,</span>
            <span class="nx">contentType</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
            <span class="nx">data</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">note</span><span class="p">)</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// this will be the view that is used to update the html</span>
<span class="kd">var</span> <span class="nx">View</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">notes</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_notes</span> <span class="o">=</span> <span class="nx">notes</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">View</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">renderContent</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#content-tpl&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">template</span> <span class="o">=</span> <span class="nx">Handlebars</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">source</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="nx">template</span><span class="p">({</span><span class="nx">note</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_notes</span><span class="p">.</span><span class="nx">getActive</span><span class="p">()});</span>

        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#editor&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>

        <span class="c1">// handle saves</span>
        <span class="kd">var</span> <span class="nx">textarea</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#app-content textarea&#39;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#app-content button&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">val</span><span class="p">();</span>
            <span class="kd">var</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">// first line is the title</span>

            <span class="nx">self</span><span class="p">.</span><span class="nx">_notes</span><span class="p">.</span><span class="nx">updateActive</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span> <span class="nx">content</span><span class="p">).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
            <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Could not update note, not found&#39;</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">},</span>
    <span class="nx">renderNavigation</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#navigation-tpl&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">template</span> <span class="o">=</span> <span class="nx">Handlebars</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">source</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="nx">template</span><span class="p">({</span><span class="nx">notes</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_notes</span><span class="p">.</span><span class="nx">getAll</span><span class="p">()});</span>

        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#app-navigation ul&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>

        <span class="c1">// create a new note</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#new-note&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">note</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">title</span><span class="o">:</span> <span class="nx">translations</span><span class="p">.</span><span class="nx">newNote</span><span class="p">,</span>
                <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;&#39;</span>
            <span class="p">};</span>

            <span class="nx">self</span><span class="p">.</span><span class="nx">_notes</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">note</span><span class="p">).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
                <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#editor textarea&#39;</span><span class="p">).</span><span class="nx">focus</span><span class="p">();</span>
            <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Could not create note&#39;</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">});</span>

        <span class="c1">// show app menu</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#app-navigation .app-navigation-entry-utils-menu-button&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">entry</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">closest</span><span class="p">(</span><span class="s1">&#39;.note&#39;</span><span class="p">);</span>
            <span class="nx">entry</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.app-navigation-entry-menu&#39;</span><span class="p">).</span><span class="nx">toggleClass</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="c1">// delete a note</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#app-navigation .note .delete&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">entry</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">closest</span><span class="p">(</span><span class="s1">&#39;.note&#39;</span><span class="p">);</span>
            <span class="nx">entry</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.app-navigation-entry-menu&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">);</span>

            <span class="nx">self</span><span class="p">.</span><span class="nx">_notes</span><span class="p">.</span><span class="nx">removeActive</span><span class="p">().</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
            <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Could not delete note, not found&#39;</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">});</span>

        <span class="c1">// load a note</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#app-navigation .note &gt; a&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">parent</span><span class="p">().</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="mi">10</span><span class="p">);</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">_notes</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#editor textarea&#39;</span><span class="p">).</span><span class="nx">focus</span><span class="p">();</span>
        <span class="p">});</span>
    <span class="p">},</span>
    <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">renderNavigation</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">renderContent</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">notes</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Notes</span><span class="p">(</span><span class="nx">OC</span><span class="p">.</span><span class="nx">generateUrl</span><span class="p">(</span><span class="s1">&#39;/apps/ownnotes/notes&#39;</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">View</span><span class="p">(</span><span class="nx">notes</span><span class="p">);</span>
<span class="nx">notes</span><span class="p">.</span><span class="nx">loadAll</span><span class="p">().</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
<span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Could not load notes&#39;</span><span class="p">);</span>
<span class="p">});</span>


<span class="p">});</span>

<span class="p">})(</span><span class="nx">OC</span><span class="p">,</span> <span class="nb">window</span><span class="p">,</span> <span class="nx">jQuery</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="apply-finishing-touches">
<h2>Apply finishing touches<a class="headerlink" href="#apply-finishing-touches" title="Permalink to this headline">¶</a></h2>
<p>Now the only thing left is to style the textarea in a nicer fashion. To do that open <strong>ownnotes/css/style.css</strong> and replace the content with the following <a class="reference internal" href="css.html"><span class="doc">CSS</span></a> code:</p>
<div class="highlight-css"><div class="highlight"><pre><span></span><span class="p">#</span><span class="nn">app-content-wrapper</span> <span class="p">{</span>
    <span class="k">height</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">#</span><span class="nn">editor</span> <span class="p">{</span>
    <span class="k">height</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
    <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">#</span><span class="nn">editor</span> <span class="p">.</span><span class="nc">input</span> <span class="p">{</span>
    <span class="k">height</span><span class="p">:</span> <span class="nb">calc</span><span class="p">(</span><span class="mi">100</span><span class="kt">%</span> <span class="o">-</span> <span class="mi">51</span><span class="kt">px</span><span class="p">);</span>
    <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">#</span><span class="nn">editor</span> <span class="p">.</span><span class="nc">save</span> <span class="p">{</span>
    <span class="k">height</span><span class="p">:</span> <span class="mi">50</span><span class="kt">px</span><span class="p">;</span>
    <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
    <span class="k">text-align</span><span class="p">:</span> <span class="kc">center</span><span class="p">;</span>
    <span class="k">border-top</span><span class="p">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="kc">solid</span> <span class="mh">#ccc</span><span class="p">;</span>
    <span class="k">background-color</span><span class="p">:</span> <span class="mh">#fafafa</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">#</span><span class="nn">editor</span> <span class="nt">textarea</span> <span class="p">{</span>
    <span class="k">height</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
    <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
    <span class="k">border</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">margin</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">border-radius</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">overflow-y</span><span class="p">:</span> <span class="kc">auto</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">#</span><span class="nn">editor</span> <span class="nt">button</span> <span class="p">{</span>
    <span class="k">height</span><span class="p">:</span> <span class="mi">44</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Congratulations! You&#8217;ve written your first Nextcloud app. You can now either try to further improve the tutorial notes app or start writing your own app.</p>
</div>
</div>


            
<ul class="prevnext-title list-unstyled list-inline">
  <li class="prev">
    <a href="changelog.html" title="Previous Chapter: Changelog"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm">&laquo; Changelog</span>
    </a>
  </li>
  <li class="next">
    <a href="startapp.html" title="Next Chapter: Create an app"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm">Create an app &raquo;</span>
    </a>
  </li>
</ul>
					</div>
				</div>
			</div>
  </main>  
  </div>
</div>
<div class="container">
<div class="row">
    <div class="col-lg-12 footer-social-icons">
      <p class="text-center"><a target="_blank" href="https://plus.google.com/104036748063781940910/about"><img width=50 src="../_static/img/social/googleplus.svg" title="Follow us on Google Plus!" alt="Follow us on Google Plus!"></img></a>
      <a target="_blank" href="https://www.facebook.com/Nextclouders"><img width=50 src="../_static/img/social/facebook.svg" title="Like our facebook page!" alt="Like our facebook page!"></img></a>
      <a target="_blank" href="https://twitter.com/Nextclouders"><img width=50 src="../_static/img/social/twitter.svg" title="Subscribe to our twitter channel!" alt="Subscribe to our twitter channel!"></img></a>
      <a target="_blank" href="https://nextcloud.com/blogfeed"><img class="img-circle" width=50 src="../_static/img/social/rss.svg" title="Subscribe to our news feed!" alt="Subscribe to our news feed!"></img></a>
      <a target="_blank" href="https://newsletter.nextcloud.com/"><img class="img-circle" width=50 src="../_static/img/social/mail.svg"  title="Subscribe to our newsletter!" alt="Subscribe to our newsletter!"></img></a></p>
    </div>
    <div class="text-center">
      <p>All documentation licensed under the <a href="https://creativecommons.org/licenses/by/3.0/us/">Creative Commons Attribution 3.0 Unported license</a>.</p>
      <p><a href="https://github.com/nextcloud/documentation/graphs/contributors">See who contributed to our documentation/credits</a>.</p>
    </div>
</div>
</div>
<footer class="content-info" role="contentinfo">
<div class="container">
   <div class="row">
     <div class="col-sm-2 col-sm-offset-1">
        <div class="footer-nav">
          <h4>About Nextcloud</h4>
          <ul id="menu-about" class="menu">
            <li><a href="https://nextcloud.com/about/">About us</a></li>
            <li><a href="https://nextcloud.com/contact/">Contact us</a></li>
            <li><a href="https://nextcloud.com/press/">Press</a></li>
            <li><a href="https://nextcloud.com/privacy/">Privacy policy</a></li>
          </ul>
        </div>
     </div>
     <div class="col-sm-2 col-sm-offset-2">
     </div>
     <div class="col-sm-2 col-sm-offset-2">
        <div class="footer-nav">
          <h4>Interact</h4>
          <ul id="menu-interact" class="menu">
            <li class="menu-irc-channel"><a href="https://webchat.freenode.net/?channels=nextcloud">IRC Channel</a></li>
            <li class="menu-forums"><a href="https://help.nextcloud.com/">Forums</a></li>
          </ul>
        </div>
     </div>
   </div>
   <div class="row">
      <div class="col-lg-12 footer-text">
        <p>
              &copy; Copyright 2012-2017, The Nextcloud developers.  <small><a href="https://nextcloud.com/impressum">Legal Notice</a></small><br/>
        </p>
      </div>
    </div>
  </div>
</footer>
  </body>
</html>