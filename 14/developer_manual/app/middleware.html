

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Middleware &mdash; Nextcloud 14 Developer Manual 14 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'14',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Container" href="container.html" />
    <link rel="prev" title="Routing" href="routes.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/logo-white.png" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../general/index.html">General contributor guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="startapp.html">Create an app</a></li>
<li class="toctree-l1"><a class="reference internal" href="init.html">Navigation and pre-app configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="info.html">App metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="classloader.html">Classloader</a></li>
<li class="toctree-l1"><a class="reference internal" href="request.html">Request lifecycle</a></li>
<li class="toctree-l1"><a class="reference internal" href="routes.html">Routing</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Middleware</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#parsing-annotations">Parsing annotations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="container.html">Container</a></li>
<li class="toctree-l1"><a class="reference internal" href="controllers.html">Controllers</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">RESTful API</a></li>
<li class="toctree-l1"><a class="reference internal" href="templates.html">Templates</a></li>
<li class="toctree-l1"><a class="reference internal" href="js.html">JavaScript</a></li>
<li class="toctree-l1"><a class="reference internal" href="css.html">CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="l10n.html">Translation</a></li>
<li class="toctree-l1"><a class="reference internal" href="theming.html">Theming support</a></li>
<li class="toctree-l1"><a class="reference internal" href="schema.html">Database schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="database.html">Database access</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="filesystem.html">Filesystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="appdata.html">AppData</a></li>
<li class="toctree-l1"><a class="reference internal" href="users.html">User management</a></li>
<li class="toctree-l1"><a class="reference internal" href="two-factor-provider.html">Two-factor providers</a></li>
<li class="toctree-l1"><a class="reference internal" href="hooks.html">Hooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="backgroundjobs.html">Background jobs (Cron)</a></li>
<li class="toctree-l1"><a class="reference internal" href="settings.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="migrations.html">Migrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="repair.html">Repair steps</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="publishing.html">App store publishing</a></li>
<li class="toctree-l1"><a class="reference internal" href="code_signing.html">Code signing</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">App development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/index.html">Design guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../android_library/index.html">Android application development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../client_apis/index.html">Client APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core/index.html">Core development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bugtracker/index.html">Bugtracker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commun/index.html">Help and communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Documentation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Nextcloud 14 Developer Manual</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">App development</a> &raquo;</li>
        
      <li>Middleware</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/nextcloud/documentation/edit/stable14/developer_manual/app/middleware.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="middleware">
<h1>Middleware<a class="headerlink" href="#middleware" title="Permalink to this headline">Â¶</a></h1>
<p>Middleware is logic that is run before and after each request and is modelled after <a class="reference external" href="https://docs.djangoproject.com/en/dev/topics/http/middleware/">Django&#8217;s Middleware system</a>. It offers the following hooks:</p>
<ul class="simple">
<li><strong>beforeController</strong>: This is executed before a controller method is being executed. This allows you to plug additional checks or logic before that method, like for instance security checks</li>
<li><strong>afterException</strong>: This is being run when either the beforeController method or the controller method itself is throwing an exception. The middleware is asked in reverse order to handle the exception and to return a response. If the middleware can&#8217;t handle the exception, it throws the exception again</li>
<li><strong>afterController</strong>: This is being run after a successful controller method call and allows the manipulation of a Response object. The middleware is run in reverse order</li>
<li><strong>beforeOutput</strong>: This is being run after the response object has been rendered and allows the manipulation of the outputted text. The middleware is run in reverse order</li>
</ul>
<p>To generate your own middleware, simply inherit from the Middleware class and overwrite the methods that should be used.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">OCA\MyApp\Middleware</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">\OCP\AppFramework\Middleware</span><span class="p">;</span>


<span class="k">class</span> <span class="nc">CensorMiddleware</span> <span class="k">extends</span> <span class="nx">Middleware</span> <span class="p">{</span>

    <span class="sd">/**</span>
<span class="sd">     * this replaces &quot;bad words&quot; with &quot;********&quot; in the output</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeOutput</span><span class="p">(</span><span class="nv">$controller</span><span class="p">,</span> <span class="nv">$methodName</span><span class="p">,</span> <span class="nv">$output</span><span class="p">){</span>
        <span class="k">return</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">&#39;bad words&#39;</span><span class="p">,</span> <span class="s1">&#39;********&#39;</span><span class="p">,</span> <span class="nv">$output</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>The middleware can be registered in the <a class="reference internal" href="container.html"><span class="doc">Container</span></a> and added using the <strong>registerMiddleware</strong> method:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">OCA\MyApp\AppInfo</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">\OCP\AppFramework\App</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">\OCA\MyApp\Middleware\CensorMiddleware</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyApp</span> <span class="k">extends</span> <span class="nx">App</span> <span class="p">{</span>

    <span class="sd">/**</span>
<span class="sd">     * Define your dependencies in here</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="k">array</span> <span class="nv">$urlParams</span><span class="o">=</span><span class="k">array</span><span class="p">()){</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="s1">&#39;myapp&#39;</span><span class="p">,</span> <span class="nv">$urlParams</span><span class="p">);</span>

        <span class="nv">$container</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getContainer</span><span class="p">();</span>

        <span class="sd">/**</span>
<span class="sd">         * Middleware</span>
<span class="sd">         */</span>
        <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">registerService</span><span class="p">(</span><span class="s1">&#39;CensorMiddleware&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="nv">$c</span><span class="p">){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">CensorMiddleware</span><span class="p">();</span>
        <span class="p">});</span>

        <span class="c1">// executed in the order that it is registered</span>
        <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">registerMiddleware</span><span class="p">(</span><span class="s1">&#39;CensorMiddleware&#39;</span><span class="p">);</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The order is important! The middleware that is registered first gets run first in the <strong>beforeController</strong> method. For all other hooks, the order is being reversed, meaning: if a middleware is registered first, it gets run last.</p>
</div>
<div class="section" id="parsing-annotations">
<h2>Parsing annotations<a class="headerlink" href="#parsing-annotations" title="Permalink to this headline">Â¶</a></h2>
<p>Sometimes it is useful to conditionally execute code before or after a controller method. This can be done by defining custom annotations. An example would be to add a custom authentication method or simply add an additional header to the response. To access the parsed annotations, inject the <strong>ControllerMethodReflector</strong> class:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">OCA\MyApp\Middleware</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">\OCP\AppFramework\Middleware</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">\OCP\AppFramework\Utility\ControllerMethodReflector</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">\OCP\IRequest</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">HeaderMiddleware</span> <span class="k">extends</span> <span class="nx">Middleware</span> <span class="p">{</span>

  <span class="k">private</span> <span class="nv">$reflector</span><span class="p">;</span>

  <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">ControllerMethodReflector</span> <span class="nv">$reflector</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">reflector</span> <span class="o">=</span> <span class="nv">$reflector</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="sd">/**</span>
<span class="sd">   * Add custom header if @MyHeader is used</span>
<span class="sd">   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="nf">afterController</span><span class="p">(</span><span class="nv">$controller</span><span class="p">,</span> <span class="nv">$methodName</span><span class="p">,</span> <span class="nx">IResponse</span> <span class="nv">$response</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">reflector</span><span class="o">-&gt;</span><span class="na">hasAnnotation</span><span class="p">(</span><span class="s1">&#39;MyHeader&#39;</span><span class="p">))</span> <span class="p">{</span>
          <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">addHeader</span><span class="p">(</span><span class="s1">&#39;My-Header&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Now adjust the container to inject the reflector:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">OCA\MyApp\AppInfo</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">\OCP\AppFramework\App</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">\OCA\MyApp\Middleware\HeaderMiddleware</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyApp</span> <span class="k">extends</span> <span class="nx">App</span> <span class="p">{</span>

    <span class="sd">/**</span>
<span class="sd">     * Define your dependencies in here</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="k">array</span> <span class="nv">$urlParams</span><span class="o">=</span><span class="k">array</span><span class="p">()){</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="s1">&#39;myapp&#39;</span><span class="p">,</span> <span class="nv">$urlParams</span><span class="p">);</span>

        <span class="nv">$container</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getContainer</span><span class="p">();</span>

        <span class="sd">/**</span>
<span class="sd">         * Middleware</span>
<span class="sd">         */</span>
        <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">registerService</span><span class="p">(</span><span class="s1">&#39;HeaderMiddleware&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="nv">$c</span><span class="p">){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">HeaderMiddleware</span><span class="p">(</span><span class="nv">$c</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s1">&#39;ControllerMethodReflector&#39;</span><span class="p">));</span>
        <span class="p">});</span>

        <span class="c1">// executed in the order that it is registered</span>
        <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">registerMiddleware</span><span class="p">(</span><span class="s1">&#39;HeaderMiddleware&#39;</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">An annotation always starts with an uppercase letter</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="container.html" class="btn btn-neutral float-right" title="Container" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="routes.html" class="btn btn-neutral float-left" title="Routing" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021 Nextcloud GmbH.

    </p>
  </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: 14
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="https://docs.nextcloud.com/server/14/developer_manual">14</a></dd>
        
          <dd><a href="https://docs.nextcloud.com/server/15/developer_manual">15</a></dd>
        
          <dd><a href="https://docs.nextcloud.com/server/16/developer_manual">16</a></dd>
        
          <dd><a href="https://docs.nextcloud.com/server/stable/developer_manual">stable</a></dd>
        
          <dd><a href="https://docs.nextcloud.com/server/latest/developer_manual">latest</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
      </dl>
      <dl>
        
        <dt>On Read the Docs</dt>
          <dd>
            <a href="///projects//?fromdocs=">Project Home</a>
          </dd>
          <dd>
            <a href="///builds//?fromdocs=">Builds</a>
          </dd>
      </dl>
    </div>
  </div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
   

</body>
</html>